<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Support - GMT User Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body {
      min-height: 100vh;
      margin: 0;
      background: repeating-linear-gradient(135deg, #172554 0%, #1e293b 30%, #3b82f6 60%, #0f172a 100%);
      background-size: 300% 300%;
      animation: moveGradientLoop 40s linear infinite;
      position: relative;
      overflow-x: hidden;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 0;
      pointer-events: none;
      background: rgba(30,41,59,0.25) 0 0 no-repeat;
      backdrop-filter: blur(60px);
      -webkit-backdrop-filter: blur(60px);
    }
    @keyframes moveGradientLoop {
      0% { background-position: 0% 0%; }
      100% { background-position: 100% 100%; }
    }
    .fade-in-quick {
      animation: fadeInQuick 0.35s cubic-bezier(0.4,0,0.2,1) both;
    }
    @keyframes fadeInQuick {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: none; }
    }
    .support-container {
      position: relative;
      z-index: 1;
      display: flex;
      min-height: 100vh;
      color: #fff;
      text-shadow: 0 2px 8px rgba(0,0,0,0.25);
    }
    .support-nav-placeholder {
      min-width: 56px;
      max-width: 56px;
      width: 56px;
      transition: max-width 0.3s, min-width 0.3s, width 0.3s, background 0.3s, box-shadow 0.3s, border-radius 0.3s, backdrop-filter 0.3s;
      position: fixed;
      left: 0;
      top: 0;
      z-index: 2;
      background: rgba(255,255,255,0.85);
      box-shadow:
        0 8px 32px 0 rgba(30,41,59,0.18),
        2px 0 8px 0 rgba(37,99,235,0.08),
        0 1.5px 0 0 rgba(30,41,59,0.04) inset;
      border-top-right-radius: 2rem;
      border-bottom-right-radius: 2rem;
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
      border: 1.5px solid rgba(30,41,59,0.10);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .support-nav-placeholder:hover {
      background: #fff;
      min-width: 100px;
      max-width: 100px;
      width: 100px;
      box-shadow: 0 8px 32px rgba(30,41,59,0.14), 2px 0 0 0 rgba(30,41,59,0.08);
      border-top-right-radius: 2rem;
      border-bottom-right-radius: 2rem;
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
      left: 0;
    }
    .support-nav-placeholder nav {
      width: 100%;
      transition: width 0.3s;
    }
    .support-nav-placeholder nav span {
      opacity: 0;
      max-width: 0;
      transition: opacity 0.2s, max-width 0.2s;
      white-space: nowrap;
      overflow: hidden;
    }
    .support-nav-placeholder:hover nav span {
      opacity: 1;
      max-width: 120px;
    }
    .support-nav-placeholder nav a, .support-nav-placeholder nav button {
      border-radius: 1.2rem;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
      padding: 0.5rem 0.7rem;
      margin: 0 0.2rem;
    }
    .support-nav-placeholder nav a:not(.active):hover, .support-nav-placeholder nav button:not(.active):hover {
      background: #e0e7ef;
      color: #2563eb;
      box-shadow: 0 6px 24px 0 rgba(37,99,235,0.13), 0 1.5px 0 0 rgba(30,41,59,0.04) inset;
      border: 1.5px solid rgba(37,99,235,0.10);
      transition: background 0.18s, box-shadow 0.18s, border 0.18s;
    }
    /* Only show the box highlight for .active when nav is hovered */
    .support-nav-placeholder nav .active {
      position: relative;
      border-radius: 1.2rem;
      transition: background 0.18s, box-shadow 0.18s, border 0.18s;
    }
    .support-nav-placeholder:hover nav .active {
      background: #f8fbff;
      box-shadow: 0 6px 24px 0 rgba(37,99,235,0.13), 0 1.5px 0 0 rgba(30,41,59,0.04) inset;
      border: 1.5px solid rgba(37,99,235,0.13);
    }
    .support-nav-placeholder nav .active svg {
      stroke: #2563eb !important;
    }
    .support-nav-placeholder nav .active span {
      color: #2563eb !important;
      font-weight: 700 !important;
    }
    /* Sign Out button hover: invert colors */
    .support-nav-placeholder nav button#userLogout:hover {
      background: #ef4444 !important;
      color: #fff !important;
      border-radius: 1.2rem;
      box-shadow: 0 2px 8px rgba(239,68,68,0.10);
    }
    .support-nav-placeholder nav button#userLogout:hover svg {
      stroke: #fff !important;
    }
    .support-nav-placeholder nav button#userLogout:hover svg rect {
      stroke: #fff !important;
      fill: none !important;
    }
    .support-nav-placeholder nav button#userLogout:hover svg path {
      stroke: #fff !important;
      fill: none !important;
    }
    .support-nav-placeholder nav button#userLogout:hover span {
      color: #fff !important;
    }
    /* Only highlight Sign Out with a light red background when nav is hovered or button is hovered */
    .support-nav-placeholder:hover nav button#userLogout,
    .support-nav-placeholder nav button#userLogout:hover {
      background: #fef2f2;
      border-radius: 1.2rem;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
      color: #ef4444;
      box-shadow: none;
    }
    @media (max-width: 1000px) {
      .support-container {
        flex-direction: column !important;
        align-items: center !important;
      }
      .support-nav-placeholder {
        margin-top: 2rem;
        min-height: 120px;
        max-width: 95vw;
      }
    }
    .support-panel {
      background: rgba(255,255,255,0.92);
      border-radius: 1.5rem;
      box-shadow: 0 8px 32px rgba(30,41,59,0.18);
      padding: 2.5rem;
      min-height: calc(100vh - 40px);
      color: #172554;
      text-shadow: none;
      margin-left: 72px;
      margin-right: 20px;
      margin-top: 20px;
      margin-bottom: 20px;
      width: calc(100vw - 72px - 20px - 8px);
      max-width: unset;
      transition: width 0.3s, margin 0.3s;
    }
    @media (max-width: 600px) {
      .support-panel {
        padding: 1.5rem;
        min-width: unset;
        margin-left: 44px;
      }
    }
    .faq-section {
      margin-top: 2.5rem;
      width: 100%;
    }
    .faq-question {
      cursor: pointer;
      font-weight: 600;
      color: #2563eb;
      margin-bottom: 0.5rem;
      transition: color 0.2s;
    }
    .faq-question:hover {
      color: #1e40af;
    }
    .faq-answer {
      display: none;
      margin-bottom: 1.5rem;
      color: #334155;
      background: #f1f5fd;
      border-radius: 0.7rem;
      padding: 0.7rem 1.2rem;
      box-shadow: 0 2px 8px rgba(37,99,235,0.07);
    }
    .faq-question.active + .faq-answer {
      display: block;
    }
    .ticket-status-section {
      margin-top: 2.5rem;
      width: 100%;
      background: #f8fafc;
      border-radius: 1rem;
      padding: 1.5rem 2rem;
      box-shadow: 0 2px 8px rgba(30,41,59,0.07);
    }
    .live-chat-placeholder {
      margin-top: 2.5rem;
      width: 100%;
      background: #f1f5fd;
      border-radius: 1rem;
      padding: 1.5rem 2rem;
      box-shadow: 0 2px 8px rgba(37,99,235,0.07);
      color: #334155;
      font-size: 1.1rem;
      text-align: center;
    }
    /* Modal fade animations */
    .modal-fade-in {
      animation: modalFadeIn 0.25s cubic-bezier(0.4,0,0.2,1) both;
    }
    .modal-fade-out {
      animation: modalFadeOut 0.22s cubic-bezier(0.4,0,0.2,1) both;
    }
    @keyframes modalFadeIn {
      from { opacity: 0; transform: scale(0.97) translateY(24px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }
    @keyframes modalFadeOut {
      from { opacity: 1; transform: scale(1) translateY(0); }
      to { opacity: 0; transform: scale(0.97) translateY(24px); }
    }
    
    /* Animated gradient for upgrade button */
    .animate-gradient {
      background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab, #667eea, #764ba2);
      background-size: 400% 400%;
      animation: gradientShift 3s ease infinite;
    }
    
    .animate-gradient:hover {
      background: linear-gradient(-45deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3, #54a0ff, #5f27cd);
      background-size: 400% 400%;
      animation: gradientShift 2s ease infinite;
    }
    
    @keyframes gradientShift {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }
  </style>
</head>
<body>
  <div class="support-container">
    <div class="support-nav-placeholder fade-in-quick">
      <nav class="flex flex-col items-center w-full gap-6 justify-center flex-1" style="height: 100%;">
        <a href="dashboard.html" class="flex flex-col items-center group" title="Overview">
          <svg width="28" height="28" fill="none" stroke="#172554" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="2"/><rect x="14" y="3" width="7" height="7" rx="2"/><rect x="14" y="14" width="7" height="7" rx="2"/><rect x="3" y="14" width="7" height="7" rx="2"/></svg>
          <span class="text-xs mt-1 text-gray-700 group-hover:text-blue-700 font-semibold">Overview</span>
        </a>
        <a href="#" class="flex flex-col items-center group" title="Automations">
          <svg width="28" height="28" fill="none" stroke="#172554" stroke-width="2" viewBox="0 0 28 28">
            <rect x="6" y="9" width="16" height="10" rx="5"/>
            <circle cx="10" cy="14" r="1.5"/>
            <circle cx="18" cy="14" r="1.5"/>
            <path d="M14 9V4"/>
            <circle cx="14" cy="3" r="1.2"/>
          </svg>
          <span class="text-xs mt-1 text-gray-700 group-hover:text-blue-700 font-semibold">Automations</span>
        </a>
        <a href="#" class="flex flex-col items-center group" title="Insights">
          <svg width="28" height="28" fill="none" stroke="#172554" stroke-width="2" viewBox="0 0 24 24"><rect x="4" y="13" width="3" height="7" rx="1.5"/><rect x="10" y="9" width="3" height="11" rx="1.5"/><rect x="16" y="5" width="3" height="15" rx="1.5"/></svg>
          <span class="text-xs mt-1 text-gray-700 group-hover:text-blue-700 font-semibold">Insights</span>
        </a>
        <a href="team.html" class="flex flex-col items-center group" title="Team">
          <svg width="28" height="28" fill="none" stroke="#172554" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="8" cy="13" r="3"/>
            <circle cx="16" cy="13" r="3"/>
            <circle cx="12" cy="8" r="3"/>
            <path d="M2 21c0-2.5 4-4.5 10-4.5s10 2 10 4.5"/>
          </svg>
          <span class="text-xs mt-1 text-gray-700 group-hover:text-blue-700 font-semibold">Team</span>
        </a>
        <a href="settings.html" class="flex flex-col items-center group" title="Settings">
          <svg width="28" height="28" fill="none" stroke="#172554" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="3.5"/>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h.09a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
          </svg>
          <span class="text-xs mt-1 text-gray-700 group-hover:text-blue-700 font-semibold">Settings</span>
        </a>
        <a href="support.html" class="flex flex-col items-center group active" title="Support">
          <svg width="28" height="28" fill="none" stroke="#172554" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
          </svg>
          <span class="text-xs mt-1 text-gray-700 group-hover:text-blue-700 font-semibold">Support</span>
        </a>
        <button id="userLogout" class="flex flex-col items-center group focus:outline-none" title="Sign Out">
          <svg width="28" height="28" fill="none" stroke="#ef4444" stroke-width="2" viewBox="0 0 24 24"><path d="M15 12H4"/><path d="M11 8l4 4-4 4"/><rect x="2" y="2" width="20" height="20" rx="6" stroke="#ef4444" stroke-width="2" fill="none"/></svg>
          <span class="text-xs mt-1 text-red-600 group-hover:text-red-800 font-semibold">Sign Out</span>
        </button>
      </nav>
    </div>
    <div class="support-panel fade-in-quick">
      <h1 class="text-2xl font-bold mb-4">Support Center</h1>
      <p class="mb-6 text-lg text-gray-700">How can we help you today? Submit a request, check your ticket, or browse our FAQ.</p>
      <div class="flex flex-col lg:flex-row gap-8 w-full">
        <div class="w-full max-w-lg">
          <p class="mb-4 text-gray-700 bg-blue-50 rounded p-3">When you fill out this form, a support ticket will be created. Our team will review your issue and respond as soon as possible. Depending on the nature of the issue, repairs may take at least a full day to complete.</p>
          <form id="supportForm" class="bg-white rounded-xl shadow-md p-6 mb-8" style="color:#172554;">
            <h2 class="text-xl font-semibold mb-4">Contact Support</h2>
            <div class="mb-4">
              <label class="block mb-1 font-medium" for="supportSubject">Subject</label>
              <input class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" type="text" id="supportSubject" required>
            </div>
            <div class="mb-4">
              <label class="block mb-1 font-medium" for="supportMessage">Message</label>
              <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" id="supportMessage" rows="4" required></textarea>
            </div>
            <div class="mb-4">
              <label class="block mb-1 font-medium" for="supportFile">Attach File (optional)</label>
              <input class="w-full" type="file" id="supportFile">
            </div> 

            <!-- Add this after the support form fields, before the submit button -->
            <div id="proPriorityMsg" class="mb-4 text-center text-base hidden">You have <span style="color:gold; font-weight:bold; text-shadow:0 0 6px gold;">priority</span> response times as a pro</div>

            <button type="submit" id="supportSubmitBtn" class="bg-blue-700 hover:bg-blue-800 text-white font-bold py-2 px-6 rounded-lg shadow transition" disabled>Submit Request</button>
            <button type="button" id="viewTicketsBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-6 rounded-lg shadow transition mt-3 w-full">View My Tickets</button>
            
            <!-- Request Upgrade Button (Lite users only) -->
            <button type="button" id="requestUpgradeBtn" class="text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all duration-200 transform hover:-translate-y-1 mt-4 w-full hidden animate-gradient">
              <div class="flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                Request Upgrade
              </div>
            </button>
            <div id="supportFormMsg" class="mt-3 text-sm"></div>
            <div id="userTicketBox" class="hidden mt-4 bg-blue-50 border border-blue-200 text-blue-900 rounded-lg px-4 py-3 font-semibold text-center">
              Your ticket number: <span id="userTicketNumber"></span><br>
              Please keep this for your records. Our team will update you as soon as your issue is resolved.
            </div>
          </form>
          <div id="supportSuccessBanner" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white font-semibold px-6 py-3 rounded-xl shadow-lg z-50 transition-all">Your ticket has been submitted! Ticket number: <span id="ticketNumber"></span></div>
        </div>
        <div class="flex-1 flex flex-col gap-6">
          <section class="bg-white rounded-xl shadow-md p-5">
            <h3 class="text-lg font-semibold mb-2">Info & Context</h3>
            <ul class="flex flex-col gap-3">
              <li><button type="button" class="text-blue-700 hover:underline font-semibold" onclick="openModal('integrationsModal')">Integrations & Automations</button></li>
              <li><button type="button" class="text-blue-700 hover:underline font-semibold" onclick="openModal('dashboardModal')">Understanding Your Dashboard</button></li>
              <li><button type="button" class="text-blue-700 hover:underline font-semibold" onclick="openModal('billingModal')">Billing & Subscription Questions</button></li>
              <li><button type="button" class="text-blue-700 hover:underline font-semibold" onclick="openModal('privacyModal')">Security & Privacy Info</button></li>
            </ul>
          </section>

          <!-- Integrations & Automations Modal -->
          <div id="integrationsModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden" style="z-index:9999;">
            <div class="modal-content bg-white rounded-xl shadow-lg max-w-lg w-full p-8 relative overflow-y-auto max-h-[90vh]">
              <button onclick="closeModal('integrationsModal')" class="absolute top-3 right-3 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
              <h2 class="text-xl font-bold mb-3">Integrations & Automations</h2>
              <p class="mb-2 text-gray-700">Integrate your favorite tools and automate your workflows for maximum efficiency. Our platform supports a wide range of integrations, making it easy to connect your CRM, marketing tools, and more.</p>
              <p class="mb-2 text-gray-700">Automations help you save time and reduce manual work. You can set up triggers, actions, and conditions to streamline your business processes.</p>
              <p class="mb-4 text-gray-700">If you need help connecting or troubleshooting an integration, our support team is here to assist you.</p>
              <div class="mb-2 font-semibold">Frequently Asked Questions</div>
              <ul class="list-disc pl-5 text-gray-700 mb-2">
                <li><b>How to connect your CRM (HubSpot, GoHighLevel, etc.):</b> Go to Integrations in your settings, select your CRM, and follow the on-screen instructions to connect.</li>
                <li><b>How to update your lead source:</b> In your dashboard, navigate to Lead Sources and select the source you wish to update.</li>
                <li><b>What to do if an automation stops working:</b> Check your integration settings and logs. If the issue persists, contact support for troubleshooting.</li>
                <li><b>Live vs paused automation: what's the difference?</b> Live automations run automatically; paused automations are inactive and do not trigger until reactivated.</li>
              </ul>
            </div>
          </div>

          <!-- Dashboard Modal -->
          <div id="dashboardModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden" style="z-index:9999;">
            <div class="modal-content bg-white rounded-xl shadow-lg max-w-lg w-full p-8 relative overflow-y-auto max-h-[90vh]">
              <button onclick="closeModal('dashboardModal')" class="absolute top-3 right-3 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
              <h2 class="text-xl font-bold mb-3">Understanding Your Dashboard</h2>
              <p class="mb-2 text-gray-700">Your dashboard provides a real-time overview of your key metrics, automations, and client insights. Use it to monitor performance and identify opportunities for growth.</p>
              <p class="mb-2 text-gray-700">Metrics are updated regularly to ensure you have the latest information at your fingertips.</p>
              <p class="mb-4 text-gray-700">If you notice any discrepancies or have questions about your data, check the FAQs below or reach out to support.</p>
              <div class="mb-2 font-semibold">Frequently Asked Questions</div>
              <ul class="list-disc pl-5 text-gray-700 mb-2">
                <li><b>What do these metrics mean?</b> Hover over each metric for a tooltip explanation, or see our documentation for details.</li>
                <li><b>How often does the dashboard update?</b> Most metrics update every 15 minutes; some may update hourly.</li>
                <li><b>Why aren't my leads showing up?</b> Ensure your integrations are connected and data is syncing. If issues persist, contact support.</li>
                <li><b>Reporting anomalies: what's the check?</b> Double-check your filters and date ranges. If something seems off, let us know.</li>
              </ul>
            </div>
          </div>

          <!-- Billing Modal -->
          <div id="billingModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden" style="z-index:9999;">
            <div class="modal-content bg-white rounded-xl shadow-lg max-w-lg w-full p-8 relative overflow-y-auto max-h-[90vh]">
              <button onclick="closeModal('billingModal')" class="absolute top-3 right-3 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
              <h2 class="text-xl font-bold mb-3">Billing & Subscription Questions</h2>
              <p class="mb-2 text-gray-700">Manage your subscription, update payment methods, and view invoices all in one place. We offer flexible plans to suit your business needs.</p>
              <p class="mb-2 text-gray-700">If you have questions about billing or need to make changes to your plan, see the FAQs below or contact our billing team.</p>
              <p class="mb-4 text-gray-700">Your account and payment information are always kept secure.</p>
              <div class="mb-2 font-semibold">Frequently Asked Questions</div>
              <ul class="list-disc pl-5 text-gray-700 mb-2">
                <li><b>How to update payment method:</b> Go to Billing in your account settings and click 'Update Payment Method'.</li>
                <li><b>How to view/download invoices:</b> In the Billing section, select 'Invoices' to view or download past invoices.</li>
                <li><b>Canceling or upgrading your plan:</b> Use the 'Manage Subscription' button in Billing to change or cancel your plan.</li>
                <li><b>What happens if a payment fails:</b> We'll notify you and retry the payment. If unresolved, your account may be paused until payment is received.</li>
              </ul>
            </div>
          </div>

          <!-- Privacy & Security Modal -->
          <div id="privacyModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden" style="z-index:9999;">
            <div class="modal-content bg-white rounded-xl shadow-lg max-w-lg w-full p-8 relative overflow-y-auto max-h-[90vh]">
              <button onclick="closeModal('privacyModal')" class="absolute top-3 right-3 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
              <h2 class="text-xl font-bold mb-3">Security & Privacy Info</h2>
              <p class="mb-2 text-gray-700">We prioritize your privacy and data security. Our platform uses industry-standard encryption and strict access controls to protect your information.</p>
              <p class="mb-2 text-gray-700">You have full control over your data, including the ability to delete your account or request data exports at any time.</p>
              <p class="mb-4 text-gray-700">For more details, see our Privacy Policy or contact our security team.</p>
              <div class="mb-2 font-semibold">Frequently Asked Questions</div>
              <ul class="list-disc pl-5 text-gray-700 mb-2">
                <li><b>Where is my data stored?</b> Your data is securely stored in our cloud infrastructure, with backups and redundancy.</li>
                <li><b>Who has access to my automation data?</b> Only authorized personnel and you have access. We never share your data without consent.</li>
                <li><b>How to delete your account or data:</b> Go to Account Settings and use the 'Delete Account' option, or contact support for help.</li>
              </ul>
            </div>
          </div>

          <!-- User Tickets Modal -->
          <script>
            // Modal logic with fade and outside click
            let currentModal = null;
            function openModal(id) {
              // Close any open modal
              if (currentModal && currentModal !== id) {
                closeModal(currentModal, true);
              }
              const modal = document.getElementById(id);
              if (!modal) return;
              modal.classList.remove('hidden', 'modal-fade-out');
              modal.classList.add('modal-fade-in');
              currentModal = id;
              // Outside click handler
              setTimeout(() => {
                modal.addEventListener('mousedown', outsideClickHandler);
              }, 10);
            }
            function closeModal(id, immediate) {
              const modal = document.getElementById(id);
              if (!modal) return;
              modal.removeEventListener('mousedown', outsideClickHandler);
              if (immediate) {
                modal.classList.add('hidden');
                modal.classList.remove('modal-fade-in', 'modal-fade-out');
                if (currentModal === id) currentModal = null;
                return;
              }
              modal.classList.remove('modal-fade-in');
              modal.classList.add('modal-fade-out');
              setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('modal-fade-out');
                if (currentModal === id) currentModal = null;
              }, 220);
            }
            function outsideClickHandler(e) {
              if (!e.target.classList.contains('modal-overlay')) return;
              if (currentModal) closeModal(currentModal);
            }
            // Only one modal at a time
            window.addEventListener('keydown', function(e) {
              if (e.key === 'Escape' && currentModal) closeModal(currentModal);
            });
          </script>
          <!-- Service Status Banner (always visible, now at the top) -->
          <div id="serviceStatusBanner" class="bg-white rounded-xl shadow-md p-5 border-l-4 border-blue-400 mb-2">
            <div>
              <span class="font-bold text-blue-900">Service Status:</span>
              <span id="currentServiceStatus" class="font-semibold"></span>
              <span id="currentServiceStatusDate" class="ml-2 text-xs text-gray-600"></span>
              <div id="currentServiceStatusDesc" class="text-sm text-gray-700"></div>
            </div>
          </div>
          <!-- Ticket Check Up Status Search panel follows here -->
          <section class="bg-white rounded-xl shadow-md p-5 border-l-4 border-yellow-400">
            <h3 class="text-lg font-semibold mb-2 flex items-center gap-2">Ticket Check Up Status Search <span class="text-yellow-400 text-xl">⭐</span> <span class="text-xs bg-gray-200 rounded px-2 py-0.5 ml-1">Pro-tier</span></h3>
            <p class="text-gray-700 mb-2">Pro users can search for their ticket status by ID or email for real-time updates.</p>
            <form id="ticketStatusForm" class="mb-0">
              <input type="text" placeholder="Enter Ticket ID or Email" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2" id="ticketIdInput">
              <button type="submit" class="bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-2 px-4 rounded transition">Check Status</button>
            </form>
            <div class="text-xs text-gray-500 mt-2">Upgrade to Pro for instant ticket lookups.</div>
            <div id="ticketStatusMsg" class="mt-3 text-sm"></div>
          </section>
          <!-- Upcoming Section (Pro only, styled to match Ticket Check Up Status Search) -->
          <div id="upcomingSection" class="bg-white rounded-xl shadow-md p-5 border-l-4 border-yellow-400 mb-2 hidden">
            <div class="flex items-center gap-2 mb-2">
              <span class="font-bold text-lg">Upcoming</span>
              <span class="text-yellow-400 text-xl">&#11088;</span>
              <span class="text-xs bg-gray-200 rounded px-2 py-0.5 ml-1">Pro-tier</span>
            </div>
            <ul id="upcomingEventsList" class="list-disc pl-5 text-gray-800 text-sm"></ul>
          </div>
          <section class="bg-white rounded-xl shadow-md p-5">
            <h3 class="text-lg font-semibold mb-2 flex items-center gap-2">Response Time Messaging <span class="text-green-500 text-xl">✅</span></h3>
            <p class="text-gray-700">Our average response time is <span class="font-semibold text-blue-700">under 2 hours</span> during business days. We strive to reply to all queries as quickly as possible to boost your trust in our support.<br>
            <span class="font-semibold text-yellow-500">Pro users receive priority support</span> for even faster responses.</p>
          </section>
          <section class="bg-white rounded-xl shadow-md p-5" id="privacy">
            <h3 class="text-lg font-semibold mb-2 flex items-center gap-2">Privacy & Data Policy <span class="text-green-500 text-xl">✅</span></h3>
            <p class="text-gray-700">We take your privacy seriously. All support requests are handled securely and in compliance with our <a href="#" class="text-blue-700 hover:underline">Privacy Policy</a>. If you use AI-powered tools, your data is never shared with third parties without your consent.</p>
          </section>
        </div>
      </div>
      <div class="faq-section">
        <h2 class="text-xl font-semibold mb-3">Frequently Asked Questions</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div>
            <div class="faq-question">How do I reset my password?</div>
            <div class="faq-answer">Go to Settings &gt; Security, then click "Change Password". Follow the instructions to reset your password securely.</div>
            <div class="faq-question">How can I check my ticket status?</div>
            <div class="faq-answer">Use the support form above to request an update, or check your email for ticket updates.</div>
            <div class="faq-question">How do I update my profile information?</div>
            <div class="faq-answer">Navigate to Settings &gt; Profile. Edit your details and click "Save All Changes".</div>
            <div class="faq-question">How do I contact support?</div>
            <div class="faq-answer">Fill out the contact form above or use the live chat (coming soon!).</div>
            <div class="faq-question">How do I connect my CRM?</div>
            <div class="faq-answer">Go to Integrations, select your CRM, and follow the instructions to connect.</div>
            <div class="faq-question">What happens if a payment fails?</div>
            <div class="faq-answer">We will notify you and retry the payment. If unresolved, your account may be paused until payment is received.</div>
          </div>
          <div>
            <div class="faq-question">How do I request changes to my workflows?</div>
            <div class="faq-answer">Submit a support ticket with your requested changes and our team will review and implement them as soon as possible.</div>
            <div class="faq-question">What's included in my subscription?</div>
            <div class="faq-answer">Your subscription includes access to all platform features, integrations, and support. See the Billing section for details.</div>
            <div class="faq-question">How do I update my payment method?</div>
            <div class="faq-answer">Go to Billing in your account settings and click 'Update Payment Method'.</div>
            <div class="faq-question">How do I delete my account or data?</div>
            <div class="faq-answer">Go to Account Settings and use the 'Delete Account' option, or contact support for help.</div>
            <div class="faq-question">Why aren't my leads showing up?</div>
            <div class="faq-answer">Ensure your integrations are connected and data is syncing. If issues persist, contact support.</div>
            <div class="faq-question">How to improve your offer or messaging?</div>
            <div class="faq-answer">Request a messaging audit or review our optimization resources in the Help Center.</div>
          </div>
        </div>
      </div>
      <div class="live-chat-placeholder mt-8">
        <strong>Live Chat (Coming Soon)</strong><br>
        Our support team will be available for real-time chat soon. For now, please use the form above or check our FAQ.
      </div>
    </div>
  </div>

  <!-- User Tickets Modal (must be outside .support-container) -->
  <div id="userTicketsModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden" style="z-index:9999;">
    <div class="modal-content bg-white rounded-xl shadow-lg max-w-2xl w-full p-8 relative overflow-y-auto max-h-[90vh]">
      <button onclick="closeModal('userTicketsModal')" class="absolute top-3 right-3 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
      <h2 class="text-xl font-bold mb-3">My Ticket & Solution History</h2>
      <div class="mb-6">
        <h3 class="font-semibold mb-2">Ticket History</h3>
        <ul class="list-disc pl-5 text-gray-700"></ul>
      </div>
      <!-- The following sections are now dynamically generated by JS only -->
      </div>
      </div>

  <!-- Delete Ticket Confirmation Modal -->
  <div id="deleteTicketModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
    <div class="modal-content bg-white rounded-xl shadow-lg max-w-md w-full p-6 relative">
      <div class="text-center">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
          <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
    </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">Delete Ticket</h3>
        <p id="deleteTicketModalMsg" class="text-sm text-gray-500 mb-6"></p>
        <div class="flex space-x-3">
          <button id="cancelDeleteBtn" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
            Cancel
          </button>
          <button id="confirmDeleteBtn" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
            Delete
          </button>
  </div>
      </div>
    </div>
  </div>

  <!-- Error Modal -->
  <div id="errorModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
    <div class="modal-content bg-white rounded-xl shadow-lg max-w-md w-full p-6 relative">
      <div class="text-center">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
          <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">Error</h3>
        <p id="errorModalMsg" class="text-sm text-gray-500 mb-6"></p>
        <button onclick="document.getElementById('errorModal').classList.add('hidden')" class="w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
          OK
        </button>
      </div>
    </div>
  </div>

  <!-- Upgrade Request Modal -->
  <div id="upgradeRequestModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
    <div class="modal-content bg-white rounded-xl shadow-lg max-w-lg w-full p-8 relative">
      <button onclick="closeModal('upgradeRequestModal')" class="absolute top-3 right-3 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
      <div class="text-center">
        <div class="w-20 h-20 bg-gradient-to-br from-purple-500 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-6">
          <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M13 10V3L4 14h7v7l9-11h-7z"/>
          </svg>
        </div>
        <h3 class="text-2xl font-bold mb-4" style="color:#172554; text-shadow:none;">Upgrade Request</h3>
        <p class="text-gray-600 mb-6 text-lg" style="text-shadow:none;">We'll send a prioritized message to our team requesting your plan upgrade. We will book a call to discuss your needs and then follow through with the upgrade process.</p>
        
        <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl p-4 mb-6 border border-purple-200">
          <h4 class="font-semibold text-gray-800 mb-2" style="text-shadow:none;">What happens next?</h4>
          <ul class="text-sm text-gray-600 space-y-1 text-left" style="text-shadow:none;">
            <li class="flex items-center gap-2" style="text-shadow:none;">
              <svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M5 13l4 4L19 7"/>
              </svg>
              <span style="text-shadow:none;">Priority message sent to our team</span>
            </li>
            <li class="flex items-center gap-2" style="text-shadow:none;">
              <svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M5 13l4 4L19 7"/>
              </svg>
              <span style="text-shadow:none;">We'll schedule a consultation call</span>
            </li>
            <li class="flex items-center gap-2" style="text-shadow:none;">
              <svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M5 13l4 4L19 7"/>
              </svg>
              <span style="text-shadow:none;">Discuss your specific needs and goals</span>
            </li>
            <li class="flex items-center gap-2" style="text-shadow:none;">
              <svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M5 13l4 4L19 7"/>
              </svg>
              <span style="text-shadow:none;">Complete the upgrade process</span>
            </li>
          </ul>
        </div>
        
        <div class="flex flex-col sm:flex-row gap-3 justify-center">
          <button id="sendUpgradeRequestBtn" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:from-purple-700 hover:to-blue-700 transition-all duration-200 font-semibold shadow-lg transform hover:-translate-y-1">
            Send Request
          </button>
          <button onclick="closeModal('upgradeRequestModal')" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-semibold">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // Session/user logic (reuse from dashboard/settings)
    function getSession() {
      return (
        JSON.parse(localStorage.getItem('gmt_user')) ||
        JSON.parse(sessionStorage.getItem('gmt_user'))
      );
    }
    const user = getSession();
    const isFileProtocol = window.location.protocol === 'file:';
    if (!user || user.type !== 'user') {
      if (isFileProtocol) {
        window.location.href = '../login/login.html';
      } else {
        window.location.href = '/client/login/login.html';
      }
    }
    // Supabase config
    const supabaseUrl = 'https://mdxcytltlftuqxmlczam.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1keGN5dGx0bGZ0dXF4bWxjemFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMzg0MzMsImV4cCI6MjA2ODYxNDQzM30.wRVqK3H1lptqWsSzQy0yuYaggRA584Jbf6Bq-5MDLWQ';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    // Activity log helper
    async function logActivity(event) {
      if (!user || !user.id) return;
      await supabase.from('activity_log').insert({
        user_id: user.id,
        event: event,
        device: navigator.userAgent,
        created_at: new Date().toISOString()
      });
    }
    // Always ensure user.id and tier are correct before any user-specific actions
    async function ensureUserIdAndTier() {
      let userObj = JSON.parse(localStorage.getItem('gmt_user')) || JSON.parse(sessionStorage.getItem('gmt_user'));
      if (userObj && userObj.email) {
        const { data, error } = await supabase.from('users').select('id, tier').eq('email', userObj.email).single();
        if (data && data.id) {
          userObj.id = data.id;
          userObj.tier = data.tier;
          if (localStorage.getItem('gmt_user')) {
            localStorage.setItem('gmt_user', JSON.stringify(userObj));
          } else {
            sessionStorage.setItem('gmt_user', JSON.stringify(userObj));
          }
          // Update global user variable
          window.user = userObj;
        } else {
          // If user not found, force logout
          localStorage.removeItem('gmt_user');
          sessionStorage.removeItem('gmt_user');
          window.location.href = '/client/login/login.html';
        }
      }
    }

    // Block all user-specific actions until user.id is ensured
    window.addEventListener('DOMContentLoaded', async function() {
      await ensureUserIdAndTier();
    // Log support page view
      if (user && user.id) logActivity('Viewed support');
      // Nav logging
      document.querySelectorAll('.support-nav-placeholder nav a').forEach(link => {
        link.addEventListener('click', function(e) {
          const page = this.title || this.textContent.trim() || 'Unknown';
          if (user && user.id && page && page.toLowerCase() !== 'sign out') {
            logActivity('Navigated to ' + page);
          }
        });
      });
    });
    // Sign out logic
    document.getElementById('userLogout').addEventListener('click', function() {
      if (user && user.id) logActivity('Logged out');
      localStorage.removeItem('gmt_user');
      sessionStorage.removeItem('gmt_user');
      sessionStorage.removeItem('gmt_logged_in');
      if (isFileProtocol) {
        window.location.href = '../login/login.html';
      } else {
        window.location.href = '/client/login/login.html';
      }
    });
    // FAQ expand/collapse
    document.querySelectorAll('.faq-question').forEach(q => {
      q.addEventListener('click', function() {
        this.classList.toggle('active');
      });
    });
    // Support form validation and ticket number logic
    const supportSubject = document.getElementById('supportSubject');
    const supportMessage = document.getElementById('supportMessage');
    const supportSubmitBtn = document.getElementById('supportSubmitBtn');
    const supportForm = document.getElementById('supportForm');
    const supportFormMsg = document.getElementById('supportFormMsg');
    const supportSuccessBanner = document.getElementById('supportSuccessBanner');
    const ticketNumberSpan = document.getElementById('ticketNumber');
    const userTicketBox = document.getElementById('userTicketBox');
    const userTicketNumber = document.getElementById('userTicketNumber');

    // Utility to clear ticket info from session and UI
    function clearTicketInfo() {
      if (user && user.id) {
        sessionStorage.removeItem('gmt_user_tickets_' + user.id);
      }
      if (userTicketBox) userTicketBox.classList.add('hidden');
      if (userTicketNumber) userTicketNumber.textContent = '';
    }

    // Utility to check if user is pro
    function isProUser() {
      return user && user.tier && user.tier.toLowerCase() === 'pro';
    }

    // On page load, show all tickets for pro/core users
    // Show tickets for all users based on their tier
    async function showUserTicketsBox() {
      if (!user || !user.tier) {
        clearTicketInfo();
        return;
      }
      
      const userTier = user.tier.toLowerCase();
      
      if (userTier === 'lite') {
        // For lite users: show current ticket with status, no delete button
        const { data: tickets, error } = await supabase
          .from('tickets')
          .select('ticket_code, created_at, updated_at, id, status_id, ticket_status(name)')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false })
          .limit(1);
        
        if (error || !tickets || tickets.length === 0) {
          clearTicketInfo();
          return;
        }
        
        const ticket = tickets[0];
        const statusName = ticket.ticket_status ? ticket.ticket_status.name : 'Unknown';

        // If closed, check how long ago it was closed
        if (statusName.toLowerCase() === 'closed') {
          const closedDate = new Date(ticket.updated_at || ticket.created_at);
          const now = new Date();
          const msSinceClosed = now - closedDate;
          const daysSinceClosed = Math.floor(msSinceClosed / (1000 * 60 * 60 * 24));
          if (daysSinceClosed >= 7) {
            // Remove from user screen after 7 days
            clearTicketInfo();
            return;
          } else {
            // Show message and countdown
            const daysLeft = 7 - daysSinceClosed;
            let html = `<div class="mb-2 p-3 bg-blue-50 border border-blue-200 text-blue-900 rounded-lg">
              <div class="flex items-center justify-between mb-2">
                <span class="font-semibold">Your Ticket:</span> <span>${ticket.ticket_code}</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="font-semibold">Status:</span> 
                <span class="px-2 py-1 rounded text-xs font-bold ${getStatusColor(statusName)}">${statusName}</span>
              </div>
              <div class="mt-2 text-xs text-gray-600">
                Closed: ${closedDate.toLocaleDateString()}<br>
                <span class="text-red-600 font-semibold">This ticket is closed and will be deleted from our system after 30 days. It will disappear from your screen in ${daysLeft} day${daysLeft !== 1 ? 's' : ''}.</span>
              </div>
            </div>`;
            userTicketBox.innerHTML = html;
      userTicketBox.classList.remove('hidden');
            sessionStorage.setItem('gmt_user_tickets_' + user.id, JSON.stringify([ticket.ticket_code]));
            return;
          }
        }

        // Build lite user ticket display with status (not closed)
        let html = `<div class="mb-2 p-3 bg-blue-50 border border-blue-200 text-blue-900 rounded-lg">
          <div class="flex items-center justify-between mb-2">
            <span class="font-semibold">Your Ticket:</span> <span>${ticket.ticket_code}</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="font-semibold">Status:</span> 
            <span class="px-2 py-1 rounded text-xs font-bold ${getStatusColor(statusName)}">${statusName}</span>
          </div>
          <div class="mt-2 text-xs text-gray-600">
            Created: ${new Date(ticket.created_at).toLocaleDateString()}
          </div>
        </div>`;
        userTicketBox.innerHTML = html;
        userTicketBox.classList.remove('hidden');
        sessionStorage.setItem('gmt_user_tickets_' + user.id, JSON.stringify([ticket.ticket_code]));
        return;
      } else if (userTier === 'pro' || userTier === 'core') {
        // For pro/core users: show all tickets with delete buttons
        const ticketLimit = getTicketLimitByTier();
        const { data: tickets, error } = await supabase
          .from('tickets')
          .select('ticket_code, created_at, id')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false })
          .limit(ticketLimit);
        
        if (error || !tickets || tickets.length === 0) {
          clearTicketInfo();
          return;
        }
        
        // Store ticket codes in sessionStorage as array
        sessionStorage.setItem('gmt_user_tickets_' + user.id, JSON.stringify(tickets.map(t => t.ticket_code)));
        
        // Build ticket info box
        let html = '';
        tickets.forEach((ticket, idx) => {
          html += `<div class="mb-2 p-2 bg-blue-50 border border-blue-200 text-blue-900 rounded-lg flex items-center justify-between">
            <div>
              <span class="font-semibold">Ticket:</span> <span>${ticket.ticket_code}</span>
              ${idx === 0 ? '<span class="ml-2 px-2 py-0.5 bg-green-200 text-green-800 rounded text-xs font-bold">Latest</span>' : ''}
            </div>
            <button class="ml-4 px-2 py-1 bg-red-500 text-white rounded delete-ticket-btn" data-ticket-id="${ticket.id}" data-ticket-code="${ticket.ticket_code}">Delete</button>
          </div>`;
        });
        
        userTicketBox.innerHTML = html;
        userTicketBox.classList.remove('hidden');
        
        // Attach delete handlers for pro/core users
        userTicketBox.querySelectorAll('.delete-ticket-btn').forEach(btn => {
          btn.onclick = async function() {
            const ticketId = this.getAttribute('data-ticket-id');
            const ticketCode = this.getAttribute('data-ticket-code');
            
            // Show custom delete confirmation modal
            const deleteModal = document.getElementById('deleteTicketModal');
            const deleteModalMsg = document.getElementById('deleteTicketModalMsg');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            
            deleteModalMsg.textContent = `Are you sure you want to delete ticket ${ticketCode}? This action cannot be undone.`;
            deleteModal.classList.remove('hidden');
            
            // Handle confirm delete
            const handleConfirmDelete = async () => {
              deleteModal.classList.add('hidden');
              const { error } = await supabase.from('tickets').delete().eq('id', ticketId);
              if (!error) {
                // Remove from sessionStorage
                let arr = JSON.parse(sessionStorage.getItem('gmt_user_tickets_' + user.id) || '[]');
                arr = arr.filter(code => code !== ticketCode);
                sessionStorage.setItem('gmt_user_tickets_' + user.id, JSON.stringify(arr));
                showUserTicketsBox();
              } else {
                // Show error modal
                const errorModal = document.getElementById('errorModal');
                const errorModalMsg = document.getElementById('errorModalMsg');
                errorModalMsg.textContent = 'Failed to delete ticket. Please try again.';
                errorModal.classList.remove('hidden');
              }
            };
            
            // Handle cancel
            const handleCancel = () => {
              deleteModal.classList.add('hidden');
            };
            
            // Remove previous event listeners
            confirmDeleteBtn.removeEventListener('click', handleConfirmDelete);
            cancelDeleteBtn.removeEventListener('click', handleCancel);
            
            // Add new event listeners
            confirmDeleteBtn.addEventListener('click', handleConfirmDelete);
            cancelDeleteBtn.addEventListener('click', handleCancel);
          };
        });
      }
    }

    // Helper function to get status color
    function getStatusColor(statusName) {
      switch (statusName.toLowerCase()) {
        case 'ticket sent':
          return 'bg-blue-200 text-blue-800';
        case 'response sent':
          return 'bg-yellow-200 text-yellow-800';
        case 'resolved':
          return 'bg-green-200 text-green-800';
        case 'closed':
          return 'bg-gray-200 text-gray-800';
        default:
          return 'bg-gray-200 text-gray-800';
      }
    }



    function validateSupportForm() {
      const subject = supportSubject.value.trim();
      const message = supportMessage.value.trim();
      supportSubmitBtn.disabled = !(subject && message);
    }
    supportSubject.addEventListener('input', validateSupportForm);
    supportMessage.addEventListener('input', validateSupportForm);
    validateSupportForm();

    // Generate a user-friendly ticket code
    function generateTicketCode() {
      return 'GMT-' + Math.random().toString(36).substr(2, 6).toUpperCase();
    }

    // Get ticket limit by user tier
    function getTicketLimitByTier() {
      if (!user || !user.tier) return 1;
      switch (user.tier.toLowerCase()) {
        case 'pro': return 3;
        case 'core': return 2;
        default: return 1;
      }
    }

    // On ticket submit, refresh ticket box for pro/core users
    supportForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      supportSubmitBtn.disabled = true;
      supportFormMsg.textContent = 'Submitting...';

      // Debug: Check user object
      console.log('User object at ticket submit:', user);
      if (!user || !user.id) {
        supportFormMsg.textContent = 'User ID missing. Please log out and log in again.';
        supportSubmitBtn.disabled = false;
        return;
      }

      // Enforce ticket creation limit by tier
      const ticketLimit = getTicketLimitByTier();
      const { data: openTickets, error: openTicketsError } = await supabase
        .from('tickets')
        .select('id')
        .eq('user_id', user.id)
        .in('status_id', (await supabase.from('ticket_status').select('id').in('name', ['Ticket Sent', 'In Review', 'Waiting on User', 'Response Sent', 'Working on it'])).data.map(s => s.id));
      if (!openTicketsError && openTickets && openTickets.length >= ticketLimit) {
        supportFormMsg.textContent = `You have reached your ticket limit (${ticketLimit}) for your account tier. Please wait until an existing ticket is resolved before submitting a new one.`;
        supportSubmitBtn.disabled = false;
        return;
      }

      try {
        // 1. Get the 'Ticket Sent' status UUID
        const { data: statusData, error: statusError } = await supabase
          .from('ticket_status')
          .select('id')
          .eq('name', 'Ticket Sent')
          .single();
        if (statusError || !statusData) {
          supportFormMsg.textContent = 'Error: Could not find ticket status.';
          supportSubmitBtn.disabled = false;
          return;
        }
        // 2. Generate ticket code
        const ticketCode = generateTicketCode();
        // 3. Create the ticket
        console.log('Inserting ticket with:', {
          user_id: user.id,
          subject: supportSubject.value.trim(),
          status_id: statusData.id,
          ticket_code: ticketCode
        });
        const { data: ticket, error: ticketError } = await supabase
          .from('tickets')
          .insert([{
            user_id: user.id,
            subject: supportSubject.value.trim(),
            status_id: statusData.id,
            ticket_code: ticketCode
          }])
          .select()
          .single();
        if (ticketError || !ticket) {
          supportFormMsg.textContent = 'Error submitting ticket. Please try again.';
          console.error('Ticket insert error:', ticketError);
          supportSubmitBtn.disabled = false;
          return;
        }
        // 4. Handle file upload if present
        let fileUrl = null;
        const fileInput = document.getElementById('supportFile');
        if (fileInput && fileInput.files && fileInput.files[0]) {
          const file = fileInput.files[0];
          const { data: uploadData, error: uploadError } = await supabase.storage
            .from('support_files')
            .upload(`tickets/${ticket.id}/${file.name}`, file, { upsert: true });
          if (!uploadError && uploadData && uploadData.path) {
            const { data: publicUrl } = supabase.storage.from('support_files').getPublicUrl(uploadData.path);
            fileUrl = publicUrl.publicUrl;
          }
        }
        // 5. Insert the initial message
        let messageInsert = {
          ticket_id: ticket.id,
          sender_id: user.id,
          message: supportMessage.value.trim()
        };
        if (fileUrl) {
          messageInsert.file_url = fileUrl;
        }
        console.log('Inserting ticket message with:', messageInsert);
        const { error: msgError } = await supabase
          .from('ticket_messages')
          .insert([messageInsert]);
        if (msgError) {
          supportFormMsg.textContent = 'Error saving your message. Please contact support.';
          console.error('Ticket message insert error:', msgError);
          supportSubmitBtn.disabled = false;
          return;
        }
        // 6. Show success message and refresh ticket display for all users
        supportFormMsg.textContent = '';
        ticketNumberSpan.textContent = ticketCode;
        supportSuccessBanner.classList.remove('hidden');
        setTimeout(() => {
          supportSuccessBanner.classList.add('hidden');
        }, 6000);
        await showUserTicketsBox(); // Refresh the ticket display for all users
        supportForm.reset();
        validateSupportForm();
      } catch (err) {
        supportFormMsg.textContent = 'Unexpected error. Please try again.';
        console.error('Unexpected error:', err);
        supportSubmitBtn.disabled = false;
      }
    });

    // On DOMContentLoaded, adjust buttons and permissions
    window.addEventListener('DOMContentLoaded', async function() {
      await ensureUserIdAndTier(); // Ensure user data is loaded before other DOMContentLoaded logic
      // Log support page view
      if (user && user.id) logActivity('Viewed support');
      // Nav logging
      document.querySelectorAll('.support-nav-placeholder nav a').forEach(link => {
        link.addEventListener('click', function(e) {
          const page = this.title || this.textContent.trim() || 'Unknown';
          if (user && user.id && page && page.toLowerCase() !== 'sign out') {
            logActivity('Navigated to ' + page);
          }
        });
      });

      // Make Submit Request button as wide as View My Tickets
      const submitBtn = document.getElementById('supportSubmitBtn');
      const viewBtn = document.getElementById('viewTicketsBtn');
      if (submitBtn && viewBtn) {
        submitBtn.classList.add('w-full');
      }
      // Only allow pro users to view tickets
      if (!isProUser() && viewBtn) {
        viewBtn.style.display = 'none'; // Completely hide the button
      }
      // Restrict Check Status to pro users only
      const ticketStatusSection = document.querySelector('section.bg-white.shadow-md.border-l-4.border-yellow-400');
      if (!isProUser() && ticketStatusSection) {
        ticketStatusSection.style.display = 'none'; // Hide the check status section
      }
      await showUserTicketsBox(); // Call this after user is ensured - now works for all users
    });

    // --- Dynamic Ticket History Modal ---
    document.getElementById('viewTicketsBtn').addEventListener('click', async function() {
      if (!isProUser()) {
        alert('Only Pro users can view ticket history.');
        return;
      }
      // Fetch user's tickets and messages
      const { data: tickets, error: ticketErr } = await supabase
        .from('tickets')
        .select('id, ticket_code, subject, created_at, updated_at, status_id, ticket_status(name), user_id, ticket_messages(id, message, sent_at, sender_id)')
        .eq('user_id', user.id)
        .order('created_at', { ascending: false });
      const modal = document.getElementById('userTicketsModal');
      const ticketList = modal.querySelector('ul.list-disc');
      ticketList.innerHTML = '';

      // --- Ticket History ---
      if (ticketErr || !tickets || tickets.length === 0) {
        ticketList.innerHTML = '<li class="text-gray-500">No tickets found.</li>';
      } else {
        tickets.filter(ticket => ticket.user_id === user.id).forEach(ticket => {
          let msgHistory = '';
          if (ticket.ticket_messages && ticket.ticket_messages.length > 0) {
            msgHistory = '<ul class="ml-2">' + ticket.ticket_messages.map(m => `<li class="text-xs text-gray-700 mb-1">${new Date(m.sent_at).toLocaleString()} - ${m.message}</li>`).join('') + '</ul>';
          } else {
            msgHistory = '<span class="text-gray-500">Waiting for support response.</span>';
          }
          ticketList.innerHTML += `
            <li class="mt-4">
              <div class="rounded-lg border border-gray-200 bg-white shadow-sm p-4 mb-2">
                <div class="flex flex-wrap items-center justify-between mb-2">
                  <div class="font-bold text-base text-blue-900">Ticket: <span class="font-mono">${ticket.ticket_code || ticket.id}</span></div>
                  <span class="ml-2 px-2 py-0.5 rounded text-xs font-bold ${getStatusColor(ticket.ticket_status ? ticket.ticket_status.name : '')}">${ticket.ticket_status ? ticket.ticket_status.name : ''}</span>
                </div>
                <div class="mb-1"><b>Subject:</b> <span class="text-gray-800">${ticket.subject}</span></div>
                <div class="mb-1"><b>Created:</b> <span class="text-gray-700">${new Date(ticket.created_at).toLocaleString()}</span></div>
                <div class="mb-1"><b>Messages:</b> ${msgHistory}</div>
              </div>
            </li>
          `;
        });
        if (ticketList.innerHTML === '') {
          ticketList.innerHTML = '<li class="text-gray-500">No tickets found.</li>';
        }
      }

      // --- Response History ---
      let responseSection = modal.querySelector('#responseHistorySection');
      if (!responseSection) {
        responseSection = document.createElement('div');
        responseSection.id = 'responseHistorySection';
        modal.querySelector('.modal-content').appendChild(responseSection);
      }
      responseSection.innerHTML = '<h3 class="font-semibold mb-2 sticky top-0 bg-white z-10">Response History</h3>';
      let responseList = '';
      let foundResponse = false;
      if (tickets && tickets.length > 0) {
        tickets.forEach(ticket => {
          if (ticket.ticket_messages && ticket.ticket_messages.length > 0) {
            ticket.ticket_messages.forEach(m => {
              // Assume support/admin messages have sender_id different from user.id
              if (m.sender_id !== user.id) {
                foundResponse = true;
                responseList += `<div class="rounded border border-blue-100 bg-blue-50 p-3 mb-2">
                  <div class="text-xs text-gray-600 mb-1">Ticket: <span class="font-mono">${ticket.ticket_code}</span> | ${new Date(m.sent_at).toLocaleString()}</div>
                  <div class="text-gray-900">${m.message}</div>
                </div>`;
              }
            });
          }
        });
      }
      if (!foundResponse) {
        responseList = '<div class="text-gray-500">No support responses yet.</div>';
      }
      responseSection.innerHTML += `<div class="overflow-y-auto max-h-48">${responseList}</div>`;

      // --- Solution History ---
      let solutionSection = modal.querySelector('#solutionHistorySection');
      if (!solutionSection) {
        solutionSection = document.createElement('div');
        solutionSection.id = 'solutionHistorySection';
        modal.querySelector('.modal-content').appendChild(solutionSection);
      }
      solutionSection.innerHTML = '<h3 class="font-semibold mb-2 sticky top-0 bg-white z-10">Solution History</h3>';
      let solutionList = '';
      let foundSolution = false;
      if (tickets && tickets.length > 0) {
        tickets.forEach(ticket => {
          const status = ticket.ticket_status ? ticket.ticket_status.name.toLowerCase() : '';
          if (status === 'resolved' || status === 'closed') {
            foundSolution = true;
            // Calculate resolution time if possible
            let resolutionTime = '';
            if (ticket.created_at && ticket.updated_at) {
              const ms = new Date(ticket.updated_at) - new Date(ticket.created_at);
              if (ms > 0) {
                const mins = Math.floor(ms / 60000);
                const hours = Math.floor(mins / 60);
                const minsLeft = mins % 60;
                if (hours > 0) {
                  resolutionTime = `${hours}h ${minsLeft}m`;
                } else {
                  resolutionTime = `${minsLeft}m`;
                }
              }
            }
            solutionList += `<div class="rounded border border-green-100 bg-green-50 p-3 mb-2">
              <div class="text-xs text-gray-600 mb-1">Ticket: <span class="font-mono">${ticket.ticket_code}</span> | Resolved: ${new Date(ticket.updated_at).toLocaleString()}</div>
              <div class="text-gray-900">${ticket.subject}</div>
              <div class="text-xs text-gray-700">Resolution time: ${resolutionTime || 'N/A'}</div>
            </div>`;
          }
        });
      }
      if (!foundSolution) {
        solutionList = '<div class="text-gray-500">No solutions yet.</div>';
      }
      solutionSection.innerHTML += `<div class="overflow-y-auto max-h-48">${solutionList}</div>`;

      // Make modal scrollable and modern
      modal.querySelector('.modal-content').style.maxHeight = '80vh';
      modal.querySelector('.modal-content').style.overflowY = 'auto';
      openModal('userTicketsModal');
    });

    // Add a modal for ticket status if not present
    if (!document.getElementById('ticketStatusModal')) {
      const modalDiv = document.createElement('div');
      modalDiv.id = 'ticketStatusModal';
      modalDiv.className = 'modal-overlay fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden';
      modalDiv.innerHTML = `
        <div class="modal-content bg-white rounded-xl shadow-lg max-w-lg w-full p-8 relative overflow-y-auto max-h-[90vh]">
          <button onclick="document.getElementById('ticketStatusModal').classList.add('hidden')" class="absolute top-3 right-3 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
          <h2 class="text-xl font-bold mb-3">Ticket Status</h2>
          <div id="ticketStatusModalMsg" class="text-base text-gray-800"></div>
        </div>
      `;
      document.body.appendChild(modalDiv);
    }

    // --- Dynamic Ticket Status Lookup ---
    const ticketStatusForm = document.getElementById('ticketStatusForm');
    if (ticketStatusForm) {
      ticketStatusForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const statusMsg = document.getElementById('ticketStatusMsg');
        const modal = document.getElementById('ticketStatusModal');
        const modalMsg = document.getElementById('ticketStatusModalMsg');
        if (!isProUser()) {
          statusMsg.textContent = 'This feature is for Pro users only.';
          modalMsg.textContent = statusMsg.textContent;
          modal.classList.remove('hidden');
          return;
        }
        const ticketCode = document.getElementById('ticketIdInput').value.trim();
        if (!ticketCode) {
          statusMsg.textContent = 'Please enter a ticket code.';
          modalMsg.textContent = statusMsg.textContent;
          modal.classList.remove('hidden');
          return;
        }
        statusMsg.textContent = 'Checking status...';
        await logActivity('Checked ticket status: ' + ticketCode);
        // Fetch ticket status from Supabase using ticket_code, but only for current user
        const { data: ticket, error } = await supabase
          .from('tickets')
          .select('id, ticket_code, status_id, ticket_status(name), user_id')
          .eq('ticket_code', ticketCode)
          .eq('user_id', user.id)
          .single();
        if (error || !ticket) {
          statusMsg.textContent = 'Ticket not found or does not belong to you.';
          modalMsg.textContent = statusMsg.textContent;
        } else {
          statusMsg.textContent = `Ticket #${ticket.ticket_code}: Status - ${ticket.ticket_status ? ticket.ticket_status.name : 'Unknown'}`;
          modalMsg.textContent = statusMsg.textContent;
        }
        modal.classList.remove('hidden');
        // Do not reset the form so the message stays visible
      });
    }

    // Show/hide based on user tier
    function showProPriorityMsg() {
      if (user && user.tier && user.tier.toLowerCase() === 'pro') {
        document.getElementById('proPriorityMsg').classList.remove('hidden');
      } else {
        document.getElementById('proPriorityMsg').classList.add('hidden');
      }
    }
    
    // Show upgrade button for Lite users only
    function showUpgradeButton() {
      const upgradeBtn = document.getElementById('requestUpgradeBtn');
      if (user && user.tier && user.tier.toLowerCase() === 'lite' && upgradeBtn) {
        upgradeBtn.classList.remove('hidden');
      }
    }
    
    // Handle upgrade request
    function handleUpgradeRequest() {
      const upgradeBtn = document.getElementById('requestUpgradeBtn');
      if (upgradeBtn) {
        upgradeBtn.addEventListener('click', function() {
          openModal('upgradeRequestModal');
        });
      }
      
      const sendRequestBtn = document.getElementById('sendUpgradeRequestBtn');
      if (sendRequestBtn) {
        sendRequestBtn.addEventListener('click', async function() {
          try {
            // Create a special upgrade request ticket
            const ticketCode = 'UPGRADE-' + Math.random().toString(36).substr(2, 6).toUpperCase();
            
            // Get the 'Ticket Sent' status UUID
            const { data: statusData, error: statusError } = await supabase
              .from('ticket_status')
              .select('id')
              .eq('name', 'Ticket Sent')
              .single();
            
            if (statusError || !statusData) {
              throw new Error('Could not find ticket status');
            }
            
            // Create the upgrade request ticket
            const { data: ticket, error: ticketError } = await supabase
              .from('tickets')
              .insert([{
                user_id: user.id,
                subject: 'Plan Upgrade Request - Priority',
                status_id: statusData.id,
                ticket_code: ticketCode
              }])
              .select()
              .single();
            
            if (ticketError || !ticket) {
              throw new Error('Failed to create upgrade request');
            }
            
            // Add the upgrade request message
            const upgradeMessage = `UPGRADE REQUEST - PRIORITY

User: ${user.email || 'Unknown'}
Current Tier: Lite
Request Type: Plan Upgrade

The user has requested an upgrade from their current Lite plan. Please prioritize this request and schedule a consultation call to discuss their needs and complete the upgrade process.

This is an automated upgrade request from the support page.`;
            
            const { error: msgError } = await supabase
              .from('ticket_messages')
              .insert([{
                ticket_id: ticket.id,
                sender_id: user.id,
                message: upgradeMessage
              }]);
            
            if (msgError) {
              throw new Error('Failed to save upgrade request message');
            }
            
            // Show success message inside the modal first
            const modal = document.getElementById('upgradeRequestModal');
            const modalContent = modal.querySelector('.modal-content');
            
            // Create success banner inside modal
            const modalBanner = document.createElement('div');
            modalBanner.className = 'bg-green-500 text-white font-semibold px-6 py-3 rounded-xl shadow-lg mb-6 text-center';
            modalBanner.textContent = 'Request sent! Expect response within 1-3 working days.';
            modalBanner.style.animation = 'fadeInQuick 0.35s cubic-bezier(0.4,0,0.2,1) both';
            
            // Insert banner at the top of modal content
            modalContent.insertBefore(modalBanner, modalContent.firstChild);
            
            // Remove banner and close modal after 5 seconds
            setTimeout(() => {
              if (modalBanner.parentNode) {
                modalBanner.parentNode.removeChild(modalBanner);
              }
              closeModal('upgradeRequestModal');
            }, 5000);
            
            // Log the activity
            if (user && user.id) {
              logActivity('Requested plan upgrade');
            }
            
            // Refresh ticket display
            await showUserTicketsBox();
            
          } catch (error) {
            console.error('Upgrade request error:', error);
            
            // Show error modal
            const errorModal = document.getElementById('errorModal');
            const errorModalMsg = document.getElementById('errorModalMsg');
            if (errorModal && errorModalMsg) {
              errorModalMsg.textContent = 'Failed to submit upgrade request. Please try again or contact support directly.';
              errorModal.classList.remove('hidden');
            }
          }
        });
      }
    }
    
    window.addEventListener('DOMContentLoaded', showProPriorityMsg);
    window.addEventListener('DOMContentLoaded', showUpgradeButton);
    window.addEventListener('DOMContentLoaded', handleUpgradeRequest);

    // Remove placeholder JS for service status/upcoming and fetch from Supabase instead
    async function showServiceStatusForPro() {
      if (user && user.tier && user.tier.toLowerCase() === 'pro') {
        // Fetch current service status (most recent status_date <= now)
        const { data: currentArr, error: currErr } = await supabase
          .from('service_status')
          .select('name, description, status_date')
          .lte('status_date', new Date().toISOString())
          .order('status_date', { ascending: false })
          .limit(1);
        const current = currentArr && currentArr.length > 0 ? currentArr[0] : null;
        // Show Service Status banner
        const banner = document.getElementById('serviceStatusBanner');
        if (current) {
          banner.classList.remove('hidden');
          document.getElementById('currentServiceStatus').textContent = current.name;
          document.getElementById('currentServiceStatusDate').textContent = current.status_date ? `(${new Date(current.status_date).toLocaleString()})` : '';
          document.getElementById('currentServiceStatusDesc').textContent = current.description || '';
        } else {
          banner.classList.add('hidden');
        }
        // Fetch upcoming events (status_date > now)
        const { data: upcoming, error } = await supabase
          .from('service_status')
          .select('name, description, status_date')
          .gt('status_date', new Date().toISOString())
          .order('status_date', { ascending: true });
        // Show Upcoming section
        const section = document.getElementById('upcomingSection');
        section.classList.remove('hidden');
        const ul = document.getElementById('upcomingEventsList');
        ul.innerHTML = '';
        if (upcoming && upcoming.length > 0) {
          upcoming.forEach(ev => {
            ul.innerHTML += `<li class="mb-2"><span class="font-semibold">${ev.name}</span> - ${ev.status_date ? new Date(ev.status_date).toLocaleString() : ''}<br><span class="text-gray-600">${ev.description}</span></li>`;
          });
        } else {
          ul.innerHTML = '<li>No upcoming events.</li>';
        }
      } else {
        document.getElementById('serviceStatusBanner').classList.add('hidden');
        document.getElementById('upcomingSection').classList.add('hidden');
      }
    }
    window.addEventListener('DOMContentLoaded', showServiceStatusForPro);

    // Update JS to always show Service Status for all users
    async function showServiceStatusBanner() {
      // Fetch current service status (most recent status_date <= now)
      const { data: currentArr, error: currErr } = await supabase
        .from('service_status')
        .select('name, description, status_date')
        .lte('status_date', new Date().toISOString())
        .order('status_date', { ascending: false })
        .limit(1);
      const current = currentArr && currentArr.length > 0 ? currentArr[0] : null;
      const banner = document.getElementById('serviceStatusBanner');
      if (current) {
        banner.classList.remove('hidden');
        document.getElementById('currentServiceStatus').textContent = current.name;
        document.getElementById('currentServiceStatusDate').textContent = current.status_date ? `(${new Date(current.status_date).toLocaleString()})` : '';
        document.getElementById('currentServiceStatusDesc').textContent = current.description || '';
      } else {
        banner.classList.add('hidden');
      }
    }
    window.addEventListener('DOMContentLoaded', showServiceStatusBanner);

    // Update the pro priority message
    const proPriorityMsg = document.getElementById('proPriorityMsg');
    if (proPriorityMsg) {
      proPriorityMsg.innerHTML = 'Pro members receive <span style="color:gold; font-weight:bold; text-shadow:0 0 6px gold;">Priority Support</span>.';
    }
  </script>
</body>
</html> 