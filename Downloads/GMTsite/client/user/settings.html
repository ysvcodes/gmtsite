<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings - GMT User Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body {
      min-height: 100vh;
      margin: 0;
      background: repeating-linear-gradient(135deg, #172554 0%, #1e293b 30%, #3b82f6 60%, #0f172a 100%);
      background-size: 300% 300%;
      animation: moveGradientLoop 40s linear infinite;
      position: relative;
      overflow-x: hidden;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 0;
      pointer-events: none;
      background: rgba(30,41,59,0.25) 0 0 no-repeat;
      backdrop-filter: blur(60px);
      -webkit-backdrop-filter: blur(60px);
    }
    @keyframes moveGradientLoop {
      0% { background-position: 0% 0%; }
      100% { background-position: 100% 100%; }
    }
    @keyframes fadeInQuick {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: none; }
    }
    .fade-in-quick {
      animation: fadeInQuick 0.35s cubic-bezier(0.4,0,0.2,1) both;
    }
    .settings-container {
      position: relative;
      z-index: 1;
      display: flex;
      min-height: 100vh;
      color: #fff;
      text-shadow: 0 2px 8px rgba(0,0,0,0.25);
    }
    .settings-nav-placeholder {
      min-width: 56px;
      max-width: 56px;
      width: 56px;
      transition: max-width 0.3s, min-width 0.3s, width 0.3s, background 0.3s, box-shadow 0.3s, border-radius 0.3s, backdrop-filter 0.3s;
      position: fixed;
      left: 0;
      top: 0;
      z-index: 2;
      background: rgba(255,255,255,0.85);
      box-shadow:
        0 8px 32px 0 rgba(30,41,59,0.18),
        2px 0 8px 0 rgba(37,99,235,0.08),
        0 1.5px 0 0 rgba(30,41,59,0.04) inset;
      border-top-right-radius: 2rem;
      border-bottom-right-radius: 2rem;
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
      border: 1.5px solid rgba(30,41,59,0.10);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .settings-nav-placeholder:hover {
      background: #fff;
      min-width: 100px;
      max-width: 100px;
      width: 100px;
      box-shadow: 0 8px 32px rgba(30,41,59,0.14), 2px 0 0 0 rgba(30,41,59,0.08);
      border-top-right-radius: 2rem;
      border-bottom-right-radius: 2rem;
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
      left: 0;
    }
    .settings-nav-placeholder nav {
      width: 100%;
      transition: width 0.3s;
    }
    .settings-nav-placeholder nav span {
      opacity: 0;
      max-width: 0;
      transition: opacity 0.2s, max-width 0.2s;
      white-space: nowrap;
      overflow: hidden;
    }
    .settings-nav-placeholder:hover nav span {
      opacity: 1;
      max-width: 120px;
    }
    .settings-nav-placeholder nav a, .settings-nav-placeholder nav button {
      border-radius: 1.2rem;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
      padding: 0.5rem 0.7rem;
      margin: 0 0.2rem;
    }
    .settings-nav-placeholder nav a:not(.active):hover, .settings-nav-placeholder nav button:not(.active):hover {
      background: #e0e7ef;
      color: #2563eb;
      box-shadow: 0 6px 24px 0 rgba(37,99,235,0.13), 0 1.5px 0 0 rgba(30,41,59,0.04) inset;
      border: 1.5px solid rgba(37,99,235,0.10);
      transition: background 0.18s, box-shadow 0.18s, border 0.18s;
    }
    .settings-nav-placeholder nav button#userLogout:hover {
      background: #ef4444 !important;
      color: #fff !important;
      border-radius: 1.2rem;
      box-shadow: 0 2px 8px rgba(239,68,68,0.10);
    }
    .settings-nav-placeholder nav button#userLogout:hover svg {
      stroke: #fff !important;
    }
    .settings-nav-placeholder nav button#userLogout:hover svg rect {
      stroke: #fff !important;
      fill: none !important;
    }
    .settings-nav-placeholder nav button#userLogout:hover svg path {
      stroke: #fff !important;
      fill: none !important;
    }
    .settings-nav-placeholder nav button#userLogout:hover span {
      color: #fff !important;
    }
    .settings-nav-placeholder:not(:hover) nav button#userLogout svg {
      background: none;
      border-radius: 0;
      box-shadow: none;
      width: 28px;
      height: 28px;
      padding: 0;
      margin-bottom: 0;
      stroke: #ef4444;
    }
    .settings-nav-placeholder:hover nav button#userLogout,
    .settings-nav-placeholder nav button#userLogout:hover {
      background: #fef2f2;
      border-radius: 1.2rem;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
    }
    .settings-nav-placeholder nav .active {
      position: relative;
    }
    .settings-nav-placeholder nav .active svg {
      stroke: #2563eb !important;
    }
    .settings-nav-placeholder:hover nav .active {
      box-shadow: 0 6px 24px 0 rgba(37,99,235,0.13), 0 1.5px 0 0 rgba(30,41,59,0.04) inset;
      border: 1.5px solid rgba(37,99,235,0.13);
      transition: background 0.18s, box-shadow 0.18s, border 0.18s;
    }
    .settings-nav-placeholder nav .active span {
      color: #2563eb !important;
      font-weight: 700 !important;
    }
    .settings-nav-placeholder nav a:not(.active):hover svg,
    .settings-nav-placeholder nav button:not(.active):hover svg {
      stroke: #2563eb !important;
    }
    .settings-nav-placeholder nav .active svg {
      stroke: #2563eb !important;
    }
    .settings-nav-placeholder nav .active span {
      color: #2563eb !important;
      font-weight: 700 !important;
    }
    .settings-nav-placeholder nav a:not(.active):hover svg,
    .settings-nav-placeholder nav button:not(.active):hover svg {
      stroke: #2563eb !important;
    }
    .settings-nav-placeholder:hover nav .active {
      box-shadow: 0 6px 24px 0 rgba(37,99,235,0.13), 0 1.5px 0 0 rgba(30,41,59,0.04) inset;
      border: 1.5px solid rgba(37,99,235,0.13);
      transition: background 0.18s, box-shadow 0.18s, border 0.18s;
    }
    .settings-content {
      flex: 1;
      padding: 2rem;
      margin-left: 72px;
      margin-right: 20px;
      margin-top: 20px;
      margin-bottom: 20px;
      width: calc(100vw - 72px - 20px - 8px);
      transition: width 0.3s, margin 0.3s;
    }
    .settings-panel {
      background: rgba(255,255,255,0.92);
      border-radius: 1.5rem;
      box-shadow: 0 8px 32px rgba(30,41,59,0.18);
      padding: 2.5rem;
      min-height: calc(100vh - 40px);
      color: #172554;
      text-shadow: none;
    }
    .settings-header {
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 2px solid rgba(30,41,59,0.08);
    }
    .settings-title {
      font-size: 2rem;
      font-weight: 700;
      color: #172554;
      margin-bottom: 0.5rem;
    }
    .settings-subtitle {
      color: #64748b;
      font-size: 1.1rem;
    }
    .settings-section {
      margin-bottom: 2.5rem;
      padding: 1.5rem;
      background: rgba(255,255,255,0.6);
      border-radius: 1rem;
      border: 1px solid rgba(30,41,59,0.06);
    }
    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #172554;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .form-group {
      margin-bottom: 1.5rem;
    }
    .form-label {
      display: block;
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.5rem;
    }
    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid rgba(30,41,59,0.1);
      border-radius: 0.75rem;
      background: rgba(255,255,255,0.8);
      color: #172554;
      font-size: 1rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .form-input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
    }
    .btn-primary {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: white;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(37,99,235,0.2);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(37,99,235,0.3);
    }
    .btn-secondary {
      background: rgba(30,41,59,0.1);
      color: #172554;
      padding: 0.75rem 1.5rem;
      border: 2px solid rgba(30,41,59,0.2);
      border-radius: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-secondary:hover {
      background: rgba(30,41,59,0.15);
      border-color: rgba(30,41,59,0.3);
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 3rem;
      height: 1.5rem;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #cbd5e1;
      transition: 0.3s;
      border-radius: 1.5rem;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 1.25rem;
      width: 1.25rem;
      left: 0.125rem;
      bottom: 0.125rem;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    input:checked + .toggle-slider {
      background-color: #2563eb;
    }
    input:checked + .toggle-slider:before {
      transform: translateX(1.5rem);
    }
    .danger-zone {
      border: 2px solid #ef4444;
      background: rgba(239,68,68,0.05);
      border-radius: 1rem;
      padding: 1.5rem;
      margin-top: 2rem;
    }
    .danger-zone .section-title {
      color: #ef4444;
    }
    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(239,68,68,0.2);
    }
    .btn-danger:hover {
      background: linear-gradient(135deg, #b91c1c 0%, #7f1d1d 100%);
      box-shadow: 0 6px 16px rgba(185,28,28,0.28);
      transform: translateY(-1px);
    }
    @media (max-width: 768px) {
      .settings-content {
        margin-left: 56px;
        width: calc(100vw - 56px);
      }
      .settings-panel {
        padding: 1.5rem;
      }
      .settings-title {
        font-size: 1.5rem;
      }
    }
    /* Responsive for mobile */
    @media (max-width: 600px) {
      .settings-nav-placeholder {
        min-width: 44px;
        max-width: 44px;
        width: 44px;
      }
      .settings-content {
        margin-left: 44px;
      }
    }
    .btn-billing {
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      color: white;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(34,197,94,0.18);
    }
    .btn-billing:hover {
      background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
      box-shadow: 0 6px 16px rgba(34,197,94,0.28);
      transform: translateY(-1px);
    }
    .btn-billing:disabled,
    .btn-billing.cursor-not-allowed {
      opacity: 0.7;
      cursor: not-allowed;
    }
    .btn-billing:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(34,197,94,0.28);
    }
  </style>
</head>
<body>
  <div class="settings-container">
    <div class="settings-nav-placeholder fade-in-quick">
      <nav class="flex flex-col items-center w-full gap-6 justify-center flex-1" style="height: 100%;">
        <a href="dashboard.html" class="flex flex-col items-center group" title="Overview">
          <svg width="28" height="28" fill="none" stroke="#172554" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="2"/><rect x="14" y="3" width="7" height="7" rx="2"/><rect x="14" y="14" width="7" height="7" rx="2"/><rect x="3" y="14" width="7" height="7" rx="2"/></svg>
          <span class="text-xs mt-1 text-gray-700 group-hover:text-blue-700 font-semibold">Overview</span>
        </a>
        <a href="#" class="flex flex-col items-center group" title="Automations">
          <svg width="28" height="28" fill="none" stroke="#172554" stroke-width="2" viewBox="0 0 28 28">
            <rect x="6" y="9" width="16" height="10" rx="5"/>
            <circle cx="10" cy="14" r="1.5"/>
            <circle cx="18" cy="14" r="1.5"/>
            <path d="M14 9V4"/>
            <circle cx="14" cy="3" r="1.2"/>
          </svg>
          <span class="text-xs mt-1 text-gray-700 group-hover:text-blue-700 font-semibold">Automations</span>
        </a>
        <a href="#" class="flex flex-col items-center group" title="Insights">
          <svg width="28" height="28" fill="none" stroke="#172554" stroke-width="2" viewBox="0 0 24 24"><rect x="4" y="13" width="3" height="7" rx="1.5"/><rect x="10" y="9" width="3" height="11" rx="1.5"/><rect x="16" y="5" width="3" height="15" rx="1.5"/></svg>
          <span class="text-xs mt-1 text-gray-700 group-hover:text-blue-700 font-semibold">Insights</span>
        </a>
        <a href="team.html" class="flex flex-col items-center group" title="Team">
          <svg width="28" height="28" fill="none" stroke="#172554" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="8" cy="13" r="3"/>
            <circle cx="16" cy="13" r="3"/>
            <circle cx="12" cy="8" r="3"/>
            <path d="M2 21c0-2.5 4-4.5 10-4.5s10 2 10 4.5"/>
          </svg>
          <span class="text-xs mt-1 text-gray-700 group-hover:text-blue-700 font-semibold">Team</span>
        </a>
        <a href="settings.html" class="flex flex-col items-center group active" title="Settings">
          <svg width="28" height="28" fill="none" stroke="#172554" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="3.5"/>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h.09a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
          </svg>
          <span class="text-xs mt-1 text-gray-700 group-hover:text-blue-700 font-semibold">Settings</span>
        </a>
        <a href="support.html" class="flex flex-col items-center group" title="Support">
          <svg width="28" height="28" fill="none" stroke="#172554" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
          </svg>
          <span class="text-xs mt-1 text-gray-700 group-hover:text-blue-700 font-semibold">Support</span>
        </a>
        <button id="userLogout" class="flex flex-col items-center group focus:outline-none" title="Sign Out">
          <svg width="28" height="28" fill="none" stroke="#ef4444" stroke-width="2" viewBox="0 0 24 24"><path d="M15 12H4"/><path d="M11 8l4 4-4 4"/><rect x="2" y="2" width="20" height="20" rx="6" stroke="#ef4444" stroke-width="2" fill="none"/></svg>
          <span class="text-xs mt-1 text-red-600 group-hover:text-red-800 font-semibold">Sign Out</span>
        </button>
      </nav>
    </div>
    <div class="settings-content">
      <div class="settings-panel fade-in-quick">
        <div class="settings-header">
          <h1 class="settings-title">Settings</h1>
          <p class="settings-subtitle">Manage your account preferences and security settings</p>
        </div>

        <!-- Profile Information Section (add SVG) -->
        <div class="settings-section">
          <h2 class="section-title flex items-center">
            <svg class="mr-2" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 8-4 8-4s8 0 8 4"/></svg>
            Profile Information
          </h2>
          <form id="profileForm" autocomplete="off">
            <div class="form-group">
              <label class="form-label" data-i18n="fullName">Full Name</label>
              <input type="text" class="form-input" id="profileFullName" placeholder="Enter your full name" autocomplete="off">
            </div>
            <div class="form-group">
              <label class="form-label" data-i18n="email">Email Address</label>
              <input type="email" class="form-input" id="profileEmail" disabled>
            </div>
            <div class="form-group">
              <label class="form-label" data-i18n="company">Company</label>
              <input type="text" class="form-input" id="profileCompany" placeholder="Enter your company name" autocomplete="off">
            </div>
            <div class="form-group">
              <label class="form-label" data-i18n="phone">Phone Number</label>
              <input type="tel" class="form-input" id="profilePhone" placeholder="Enter your phone number" autocomplete="off">
            </div>
            <div class="form-group">
              <label class="form-label" data-i18n="tier">Account Tier</label>
              <input type="text" class="form-input" id="profileTier" disabled style="background:#f3f4f6;color:#172554;font-weight:bold;">
            </div>
          </form>
        </div>
        <!-- Change Email Section -->
        <div class="settings-section" id="changeEmailSection">
          <h2 class="section-title flex items-center">
            <svg class="mr-2" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 4h16v16H4z"/><path d="M22 6l-10 7L2 6"/></svg>
            Change Email
          </h2>
          <form id="changeEmailForm" autocomplete="off">
            <div class="form-group">
              <label class="form-label" for="newEmail">New Email Address</label>
              <input type="email" class="form-input" id="newEmail" placeholder="Enter new email address" autocomplete="off">
            </div>
            <button type="button" class="btn-primary" id="requestEmailOtpBtn">Request OTP</button>
            <div id="emailOtpRequestMsg" class="mt-2 text-sm"></div>
            <div id="otpSection" style="display:none;">
              <div class="form-group mt-4">
                <label class="form-label" for="emailOtp">Enter OTP sent to your new email</label>
                <input type="text" class="form-input" id="emailOtp" maxlength="6" placeholder="6-digit code">
              </div>
              <div class="flex gap-2">
                <button type="button" class="btn-primary" id="verifyEmailOtpBtn">Verify & Change Email</button>
                <button type="button" class="btn-secondary" id="resendEmailOtpBtn" style="opacity:0.6;cursor:not-allowed;" disabled>Resend Code (60s)</button>
              </div>
              <div id="emailOtpVerifyMsg" class="mt-2 text-sm"></div>
            </div>
          </form>
        </div>
        <!-- Security Section (add SVG) -->
        <div class="settings-section">
          <h2 class="section-title flex items-center">
            <svg class="mr-2" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
            Security
          </h2>
          <form id="passwordForm" autocomplete="off">
            <div class="form-group">
              <label class="form-label" data-i18n="currentPassword">Current Password</label>
              <input type="password" class="form-input" id="currentPassword" placeholder="Enter current password" autocomplete="off">
            </div>
            <div class="form-group">
              <label class="form-label" data-i18n="newPassword">New Password</label>
              <input type="password" class="form-input" id="newPassword" placeholder="Enter new password" autocomplete="off">
              <div id="passwordStrength" class="mt-1 text-sm font-semibold"></div>
            </div>
            <div class="form-group">
              <label class="form-label" data-i18n="confirmNewPassword">Confirm New Password</label>
              <input type="password" class="form-input" id="confirmNewPassword" placeholder="Confirm new password" autocomplete="off">
            </div>
            <button type="submit" class="btn-primary" data-i18n="updatePassword">Update Password</button>
            <div id="passwordMsg" class="mt-2 text-sm"></div>
          </form>
        </div>
        <!-- Advanced: Theme & Accessibility -->
        <div class="settings-section">
          <h2 class="section-title">
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
            Appearance & Accessibility
          </h2>
          <div class="form-group flex items-center justify-between">
            <div>
              <label class="form-label" data-i18n="darkModeLabel">Dark Mode</label>
              <p class="text-sm text-gray-600" data-i18n="darkModeDesc">Reduce eye strain with a dark theme</p>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="darkModeToggle">
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div class="form-group flex items-center justify-between">
            <div>
              <label class="form-label" data-i18n="fontSizeLabel">Font Size</label>
              <p class="text-sm text-gray-600" data-i18n="fontSizeDesc">Adjust for readability</p>
            </div>
            <select class="form-input" id="fontSizeSelect" style="max-width:120px;">
              <option>Small</option>
              <option>Normal</option>
              <option>Large</option>
              <option>Extra Large</option>
            </select>
          </div>
          <div class="form-group flex items-center justify-between">
            <div>
              <label class="form-label" data-i18n="timeZoneLabel">Time Zone</label>
              <p class="text-sm text-gray-600" data-i18n="timeZoneDesc">Auto-detected, but you can change it</p>
            </div>
            <select class="form-input" id="timezoneSelect" style="max-width:220px;"></select>
          </div>
          <div class="form-group flex items-center justify-between">
            <div>
              <label class="form-label" data-i18n="languageLabel">Language</label>
              <p class="text-sm text-gray-600" data-i18n="languageDesc">Choose your preferred language</p>
            </div>
            <select class="form-input" id="languageSelect" style="max-width:180px;">
              <option value="en">English</option>
              <option value="es">Spanish</option>
              <option value="fr">French</option>
              <option value="de">German</option>
              <option value="zh">Chinese</option>
              <option value="ar">Arabic</option>
              <option value="hi">Hindi</option>
              <option value="pt">Portuguese</option>
              <option value="ru">Russian</option>
              <option value="ja">Japanese</option>
            </select>
          </div>
        </div>
        <!-- 💬 Support Shortcut Section -->
        <div class="settings-section mb-6">
          <h2 class="section-title flex items-center">
            <svg class="mr-2" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            Support Shortcut
          </h2>
          <div class="text-gray-700 mb-3">Need help with your account?</div>
          <div class="flex flex-col sm:flex-row gap-2">
            <a href="support.html" class="btn-primary w-full sm:w-auto text-center">Visit Support Center</a>
          </div>
        </div>
        <!-- Billing & Subscription Panel -->
        <div class="settings-section">
          <h2 class="section-title">
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="13" rx="2"/><path d="M8 21v-4h8v4"/><path d="M12 11v-4"/></svg>
            Billing & Subscription
          </h2>
          <div id="billingInfo" class="mb-3 text-gray-800 bg-blue-50 rounded p-3"></div>
          <div class="flex flex-col sm:flex-row gap-2 mb-4">
            <button class="btn-billing w-full sm:w-1/3">Update Payment Method</button>
            <button class="btn-billing w-full sm:w-1/3">Download Past Invoices</button>
            <button class="btn-billing w-full sm:w-1/3">Change Billing Email</button>
          </div>
          <div class="flex flex-col sm:flex-row gap-2 mb-2">
            <button class="btn-secondary cursor-not-allowed opacity-70 w-full" disabled>Manage Billing</button>
            <button class="btn-secondary cursor-not-allowed opacity-70 w-full" disabled>Pay Now</button>
          </div>
          <div class="text-sm text-gray-500">Billing actions will be available here in the future.</div>
        </div>
        <!-- 🔔 Notification Preferences Section -->
        <div class="settings-section mt-6">
          <h2 class="section-title flex items-center">
            <svg class="mr-2" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 8a6 6 0 1 0-12 0c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
            Notification Preferences
          </h2>
          <div class="space-y-3 mt-3" id="notificationPrefs">
            <div class="flex items-center justify-between">
              <span>Weekly Insights Summary</span>
              <label class="toggle-switch">
                <input type="checkbox" data-pref="weekly">
                <span class="toggle-slider"></span>
                <span class="ml-2 text-sm text-gray-500 pref-label">ON</span>
              </label>
            </div>
            <div class="flex items-center justify-between">
              <span>Automation Performance Alerts</span>
              <label class="toggle-switch">
                <input type="checkbox" data-pref="automation">
                <span class="toggle-slider"></span>
                <span class="ml-2 text-sm text-gray-500 pref-label">ON</span>
              </label>
            </div>
            <div class="flex items-center justify-between">
              <span>New Feature Announcements</span>
              <label class="toggle-switch">
                <input type="checkbox" data-pref="features">
                <span class="toggle-slider"></span>
                <span class="ml-2 text-sm text-gray-500 pref-label">ON</span>
              </label>
            </div>
            <div class="flex items-center justify-between">
              <span>Billing Reminders</span>
              <label class="toggle-switch">
                <input type="checkbox" data-pref="billing">
                <span class="toggle-slider"></span>
                <span class="ml-2 text-sm text-gray-500 pref-label">ON</span>
              </label>
            </div>
            <div class="flex items-center justify-between">
              <span>System Downtime Notices</span>
              <label class="toggle-switch">
                <input type="checkbox" data-pref="downtime">
                <span class="toggle-slider"></span>
                <span class="ml-2 text-sm text-gray-500 pref-label">ON</span>
              </label>
            </div>
          </div>
        </div>
        <script>
        // Notification Preferences: Interactive toggles with localStorage persistence
        const defaultPrefs = {
          weekly: true,
          automation: true,
          features: true,
          billing: true,
          downtime: true
        };
        function loadNotificationPrefs() {
          let prefs = {};
          try {
            prefs = JSON.parse(localStorage.getItem('gmt_notification_prefs')) || {};
          } catch (e) { prefs = {}; }
          prefs = { ...defaultPrefs, ...prefs };
          document.querySelectorAll('#notificationPrefs input[type="checkbox"]').forEach(input => {
            const key = input.getAttribute('data-pref');
            input.checked = !!prefs[key];
            const label = input.parentElement.querySelector('.pref-label');
            label.textContent = input.checked ? 'ON' : 'OFF';
            input.disabled = false;
            // Add unsaved state trigger
            input.addEventListener('change', () => setUnsaved(true));
          });
        }
        if (document.readyState === 'loading') {
          window.addEventListener('DOMContentLoaded', loadNotificationPrefs);
        } else {
          loadNotificationPrefs();
        }
        </script>
        <!-- Move Data & Export Section to just above Account Activity & Sessions -->
        <!-- ...other settings sections... -->
        <!-- Data & Export Section -->
        <div class="settings-section mb-6">
          <h2 class="section-title flex items-center">
            <svg class="mr-2" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4v12m0 0l-6-6m6 6l6-6"/></svg>
            Data & Export
          </h2>
          <div class="flex flex-col sm:flex-row gap-2">
            <button class="btn-primary mb-2" data-i18n="downloadData">Download My Data</button>
            <button class="btn-primary mb-2" data-i18n="requestExport">Request Account Export</button>
            <button class="btn-primary mb-2" id="exportActivityBtn">Export Account Activity & Sessions</button>
          </div>
        </div>
        <!-- Account Activity & Sessions Section follows here -->
        <!-- Advanced: Account Activity & Sessions (Merged) -->
        <div class="settings-section">
          <h2 class="section-title" data-i18n-section="accountActivity">
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="13" rx="2"/><path d="M8 21v-4h8v4"/><path d="M12 11v-4"/></svg>
            Account Activity & Sessions
          </h2>
          <div class="flex flex-col md:flex-row gap-8">
            <div class="flex-1">
              <h3 class="font-semibold text-gray-800 mb-2" for-activity data-i18n="recentActivity">Recent Activity</h3>
              <div style="max-height:220px;overflow-y:auto;background:rgba(255,255,255,0.07);border-radius:0.75rem;padding:0.5rem 0.75rem;box-shadow:0 2px 8px rgba(30,41,59,0.04);">
                <ul class="text-sm text-gray-700" id="activityLog">
                  <!-- Real activity log will be loaded here -->
                </ul>
              </div>
            </div>
            <div class="flex-1">
              <h3 class="font-semibold text-gray-800 mb-2" for-sessions data-i18n="activeSessions">Active Sessions</h3>
              <div style="max-height:220px;overflow-y:auto;background:rgba(255,255,255,0.07);border-radius:0.75rem;padding:0.5rem 0.75rem;box-shadow:0 2px 8px rgba(30,41,59,0.04);">
                <ul class="text-sm text-gray-700" id="sessionList">
                  <!-- Real sessions will be loaded here -->
                </ul>
              </div>
            </div>
          </div>
        </div>
        <!-- Save All Changes Button (now just below Account Activity & Sessions) -->
        <div class="flex flex-col items-center mt-8 mb-4" id="saveAllContainer">
          <div id="unsavedMsg" class="text-yellow-600 font-semibold mb-2" style="display:none;" data-i18n="unsaved">You have unsaved changes.</div>
          <button class="btn-primary" id="saveAllBtn" data-i18n="saveAll">Save All Changes</button>
          <div id="saveAllMsg" class="mt-2 text-sm"></div>
          <div id="saveAllDisabledMsg" class="mt-2 text-sm text-red-600 font-semibold" style="display:none;">Please fill in all required fields appropriately.</div>
        </div>

        <!-- Enhanced Danger Zone -->
        <div class="danger-zone">
          <h2 class="section-title" data-i18n-section="dangerZone">Danger Zone</h2>
          <p class="text-sm text-gray-600 mb-4">These actions cannot be undone. Please proceed with caution.</p>
          <button class="btn-danger" id="deleteAccountBtn" data-i18n="deleteAccount">Delete Account</button>
        </div>

        <!-- Add Sign Out button to the settings page, below Save All Changes -->
        <div class="flex flex-col items-center mt-2 mb-4" id="signOutContainer">
          <button class="btn-secondary" id="signOutBtn">Sign Out</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
// Use existing Supabase config from index.html or set here
const supabaseUrl = 'https://mdxcytltlftuqxmlczam.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1keGN5dGx0bGZ0dXF4bWxjemFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMzg0MzMsImV4cCI6MjA2ODYxNDQzM30.wRVqK3H1lptqWsSzQy0yuYaggRA584Jbf6Bq-5MDLWQ';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

function getCurrentUser() {
  return JSON.parse(localStorage.getItem('gmt_user')) || JSON.parse(sessionStorage.getItem('gmt_user'));
}
const user = getCurrentUser();
if (!user) {
  window.location.href = '/client/login/login.html';
}

// --- i18n dictionary for English and Spanish ---
const i18n = {
  en: {
    saveAll: 'Save All Changes',
    unsaved: 'You have unsaved changes.',
    profileInfo: 'Profile Information',
    security: 'Security',
    currentPassword: 'Current Password',
    newPassword: 'New Password',
    confirmNewPassword: 'Confirm New Password',
    updatePassword: 'Update Password',
    accountActivity: 'Account Activity & Sessions',
    recentActivity: 'Recent Activity',
    activeSessions: 'Active Sessions',
    dangerZone: 'Danger Zone',
    downloadData: 'Download My Data',
    requestExport: 'Request Account Export',
    deleteAccount: 'Delete Account',
    fontSizeLabel: 'Font Size',
    fontSizeDesc: 'Adjust for readability',
    darkModeLabel: 'Dark Mode',
    darkModeDesc: 'Reduce eye strain with a dark theme',
    timeZoneLabel: 'Time Zone',
    timeZoneDesc: 'Auto-detected, but you can change it',
    languageLabel: 'Language',
    languageDesc: 'Choose your preferred language',
    fullName: 'Full Name',
    email: 'Email Address',
    company: 'Company',
    phone: 'Phone Number',
    phoneError: 'Phone number must be at least 10 digits.',
    phoneModalTitle: 'Invalid Phone Number',
    phoneModalMsg: 'Phone number must be at least 10 digits and contain only numbers.',
    invalidPw: 'Incorrect password.',
    requiredPw: 'Password required.',
    deleteTitle: 'Delete Account',
    deletePwPrompt: 'Please enter your password to confirm account deletion.',
    deleteAutoTitle: 'Delete Automations?',
    deleteAutoMsg: 'Do you want to delete your automations for',
    deleteReviewTitle: 'Account Deletion Requested',
    deleteReviewMsg: 'Your account is being reviewed before proper deletion. You will be notified when the process is complete.',
    close: 'Close',
    confirm: 'Confirm',
    cancel: 'Cancel',
    yes: 'Yes',
    no: 'No',
    save: 'Save',
    leaveWithoutSaving: 'Leave Without Saving',
    unsavedModalTitle: 'You have unsaved changes',
    unsavedModalMsg: 'Do you want to save before leaving?'
  },
  es: {
    saveAll: 'Guardar todos los cambios',
    unsaved: 'Tienes cambios sin guardar.',
    profileInfo: 'Información de perfil',
    security: 'Seguridad',
    currentPassword: 'Contraseña actual',
    newPassword: 'Nueva contraseña',
    confirmNewPassword: 'Confirmar nueva contraseña',
    updatePassword: 'Actualizar contraseña',
    accountActivity: 'Actividad de la cuenta y sesiones',
    recentActivity: 'Actividad reciente',
    activeSessions: 'Sesiones activas',
    dangerZone: 'Zona de peligro',
    downloadData: 'Descargar mis datos',
    requestExport: 'Solicitar exportación de cuenta',
    deleteAccount: 'Eliminar cuenta',
    fontSizeLabel: 'Tamaño de fuente',
    fontSizeDesc: 'Ajustar para la legibilidad',
    darkModeLabel: 'Modo oscuro',
    darkModeDesc: 'Reduce la fatiga visual con un tema oscuro',
    timeZoneLabel: 'Zona horaria',
    timeZoneDesc: 'Detectado automáticamente, pero puedes cambiarlo',
    languageLabel: 'Idioma',
    languageDesc: 'Elige tu idioma preferido',
    fullName: 'Nombre completo',
    email: 'Correo electrónico',
    company: 'Empresa',
    phone: 'Teléfono',
    phoneError: 'El número debe tener al menos 10 dígitos.',
    phoneModalTitle: 'Número de teléfono inválido',
    phoneModalMsg: 'El número debe tener al menos 10 dígitos y contener solo números.',
    invalidPw: 'Contraseña incorrecta.',
    requiredPw: 'Se requiere contraseña.',
    deleteTitle: 'Eliminar cuenta',
    deletePwPrompt: 'Por favor, introduce tu contraseña para confirmar la eliminación.',
    deleteAutoTitle: '¿Eliminar automatizaciones?',
    deleteAutoMsg: '¿Deseas eliminar tus automatizaciones para',
    deleteReviewTitle: 'Solicitud de eliminación de cuenta',
    deleteReviewMsg: 'Tu cuenta está siendo revisada antes de la eliminación. Se te notificará cuando el proceso esté completo.',
    close: 'Cerrar',
    confirm: 'Confirmar',
    cancel: 'Cancelar',
    yes: 'Sí',
    no: 'No',
    save: 'Guardar',
    leaveWithoutSaving: 'Salir sin guardar',
    unsavedModalTitle: 'Tienes cambios sin guardar',
    unsavedModalMsg: '¿Quieres guardar antes de salir?'
  }
};

// --- Apply language to all visible UI text ---
function applyLanguage(lang) {
  const dict = i18n[lang] || i18n['en'];
  // Section headers
  var el = document.querySelector('.settings-section h2.section-title[data-i18n-section="profileInfo"]');
  if (el) el.textContent = dict.profileInfo;
  el = document.querySelector('.settings-section h2.section-title[data-i18n-section="security"]');
  if (el) el.textContent = dict.security;
  el = document.querySelector('.settings-section h2.section-title[data-i18n-section="accountActivity"]');
  if (el) el.textContent = dict.accountActivity;
  el = document.querySelector('.settings-section h2.section-title[data-i18n-section="dangerZone"]');
  if (el) el.textContent = dict.dangerZone;
  // Profile labels
  el = document.querySelector('[data-i18n="fullName"]');
  if (el) el.textContent = dict.fullName;
  el = document.querySelector('[data-i18n="email"]');
  if (el) el.textContent = dict.email;
  el = document.querySelector('[data-i18n="company"]');
  if (el) el.textContent = dict.company;
  el = document.querySelector('[data-i18n="phone"]');
  if (el) el.textContent = dict.phone;
  // Security labels
  el = document.querySelector('label[for="currentPassword"]');
  if (el) el.textContent = dict.currentPassword;
  el = document.querySelector('label[for="newPassword"]');
  if (el) el.textContent = dict.newPassword;
  el = document.querySelector('label[for="confirmNewPassword"]');
  if (el) el.textContent = dict.confirmNewPassword;
  el = document.getElementById('passwordForm') ? document.getElementById('passwordForm').querySelector('button[type="submit"]') : null;
  if (el) el.textContent = dict.updatePassword;
  // Appearance & Accessibility
  el = document.querySelector('[data-i18n="fontSizeLabel"]');
  if (el) el.textContent = dict.fontSizeLabel;
  el = document.querySelector('[data-i18n="fontSizeDesc"]');
  if (el) el.textContent = dict.fontSizeDesc;
  el = document.querySelector('[data-i18n="darkModeLabel"]');
  if (el) el.textContent = dict.darkModeLabel;
  el = document.querySelector('[data-i18n="darkModeDesc"]');
  if (el) el.textContent = dict.darkModeDesc;
  el = document.querySelector('[data-i18n="timeZoneLabel"]');
  if (el) el.textContent = dict.timeZoneLabel;
  el = document.querySelector('[data-i18n="timeZoneDesc"]');
  if (el) el.textContent = dict.timeZoneDesc;
  el = document.querySelector('[data-i18n="languageLabel"]');
  if (el) el.textContent = dict.languageLabel;
  el = document.querySelector('[data-i18n="languageDesc"]');
  if (el) el.textContent = dict.languageDesc;
  // Save/unsaved
  el = document.getElementById('saveAllBtn');
  if (el) el.textContent = dict.saveAll;
  el = document.getElementById('unsavedMsg');
  if (el) el.textContent = dict.unsaved;
  // Account Activity & Sessions
  el = document.querySelector('h3[for-activity]');
  if (el) el.textContent = dict.recentActivity;
  el = document.querySelector('h3[for-sessions]');
  if (el) el.textContent = dict.activeSessions;
  // Danger Zone buttons
  el = document.querySelector('button.btn-secondary.mb-2[data-i18n="downloadData"]');
  if (el) el.textContent = dict.downloadData;
  el = document.querySelector('button.btn-secondary.mb-2[data-i18n="requestExport"]');
  if (el) el.textContent = dict.requestExport;
  el = document.getElementById('deleteAccountBtn');
  if (el) el.textContent = dict.deleteAccount;
  // Phone error
  el = document.getElementById('phoneErrorMsg');
  if (el) el.textContent = '';
}

// --- On page load, apply language from Supabase or localStorage ---
window.addEventListener('DOMContentLoaded', async function() {
  let lang = 'en';
  const { data } = await supabase.from('users').select('language').eq('email', user.email).single();
  if (data && data.language) lang = data.language;
  localStorage.setItem('gmt_lang', lang);
  applyLanguage(lang);
  document.getElementById('languageSelect').value = lang;
});

document.getElementById('languageSelect').addEventListener('change', async function() {
  localStorage.setItem('gmt_lang', this.value);
  applyLanguage(this.value);
  setUnsaved(true);
  // Save language to Supabase immediately
  await supabase.from('users').update({ language: this.value }).eq('email', user.email);
});

// --- Auto-detect timezone if not set in Supabase, otherwise use saved value ---
function detectBrowserTimezoneGMT() {
  const offset = -new Date().getTimezoneOffset() / 60;
  if (offset === 0) return 'GMT';
  if (offset === 1) return 'BST';
  if (offset === -5) return 'EST';
  if (offset === -6) return 'CST';
  if (offset === -7) return 'MST';
  if (offset === -8) return 'PST';
  if (offset === 10) return 'AEST';
  if (offset === 11) return 'AEDT';
  if (offset === 9.5) return 'ACST';
  if (offset === 8) return 'AWST';
  if (offset === 12) return 'NZST';
  if (offset === -10) return 'HST';
  if (offset === -9) return 'AKST';
  if (offset === -4) return 'AST';
  return 'GMT';
}

// --- Define loadUserSettings to fetch and prefill all fields from Supabase ---
async function loadUserSettings() {
  populateTimezoneDropdown();
  // Fetch user profile and settings from user_profiles and user_settings
  let { data: profile, error: profileError } = await supabase
    .from('user_profiles')
    .select('full_name, company, phone')
    .eq('user_id', user.id)
    .maybeSingle();
  if (!profile) {
    // Insert a blank profile row if missing
    await supabase.from('user_profiles').insert({ user_id: user.id });
    // Refetch
    const res = await supabase
      .from('user_profiles')
      .select('full_name, company, phone')
      .eq('user_id', user.id)
      .maybeSingle();
    profile = res.data;
  }
  let { data: settings, error: settingsError } = await supabase
    .from('user_settings')
    .select('timezone, language, dark_mode, font_size, notify_weekly, notify_automation, notify_features, notify_billing, notify_downtime')
    .eq('user_id', user.id)
    .maybeSingle();
  if (!settings) {
    // Insert a blank settings row if missing
    await supabase.from('user_settings').insert({ user_id: user.id });
    // Refetch
    const res = await supabase
      .from('user_settings')
      .select('timezone, language, dark_mode, font_size, notify_weekly, notify_automation, notify_features, notify_billing, notify_downtime')
      .eq('user_id', user.id)
      .maybeSingle();
    settings = res.data;
  }
  // Always get email and tier from users table
  const { data: userData, error: userError } = await supabase
    .from('users')
    .select('email, tier')
    .eq('id', user.id)
    .single();
  if (profileError || settingsError || userError || !userData) {
    console.error('Failed to load user settings:', profileError || settingsError || userError);
    return;
  }
  document.getElementById('profileFullName').value = (profile && profile.full_name) || '';
  document.getElementById('profileEmail').value = userData.email || '';
  document.getElementById('profileCompany').value = (profile && profile.company) || '';
  document.getElementById('profilePhone').value = (profile && profile.phone) || '';
  // Set tier display value and style
  let tierDisplay = 'Unknown';
  if (userData.tier === 'pro') {
    tierDisplay = 'Pro';
  } else if (userData.tier === 'core') {
    tierDisplay = 'Core';
  } else if (userData.tier === 'lite') {
    tierDisplay = 'Lite';
  }
  const tierInput = document.getElementById('profileTier');
  tierInput.value = tierDisplay;
  if (userData.tier === 'pro') {
    tierInput.style.color = '#FFD700';
    tierInput.style.fontWeight = 'bold';
    tierInput.style.textShadow = '0 0 8px #FFD700, 0 0 4px #fff, 0 0 12px #FFD700';
  } else if (userData.tier === 'core') {
    tierInput.style.color = '#a259ff';
    tierInput.style.fontWeight = 'bold';
    tierInput.style.textShadow = '0 0 8px #a259ff, 0 0 4px #fff, 0 0 12px #a259ff';
  } else if (userData.tier === 'lite') {
    tierInput.style.color = '#6b7280';
    tierInput.style.fontWeight = 'bold';
    tierInput.style.textShadow = '0 0 8px #6b7280, 0 0 4px #fff, 0 0 12px #6b7280';
  } else {
    tierInput.style.color = '#172554';
    tierInput.style.fontWeight = 'bold';
    tierInput.style.textShadow = 'none';
  }
  let tz = settings && settings.timezone;
  if (!tz) {
    tz = detectBrowserTimezoneGMT();
    document.getElementById('timezoneSelect').value = tz;
    // Save detected timezone to DB for future loads
    await supabase.from('user_settings').update({ timezone: tz }).eq('user_id', user.id);
  } else {
    document.getElementById('timezoneSelect').value = tz;
  }
  document.getElementById('languageSelect').value = (settings && settings.language) || 'en';
  let fontSize = settings && settings.font_size;
  if (!fontSize || !['Small','Normal','Large','Extra Large'].includes(fontSize)) {
    fontSize = 'Normal';
  }
  document.getElementById('fontSizeSelect').value = fontSize;
  applyFontSize(fontSize);
  document.getElementById('darkModeToggle').checked = !!(settings && settings.dark_mode);
  // Set notification preferences from Supabase
  const notifPrefs = {
    weekly: settings && settings.notify_weekly !== undefined ? settings.notify_weekly : true,
    automation: settings && settings.notify_automation !== undefined ? settings.notify_automation : true,
    features: settings && settings.notify_features !== undefined ? settings.notify_features : true,
    billing: settings && settings.notify_billing !== undefined ? settings.notify_billing : true,
    downtime: settings && settings.notify_downtime !== undefined ? settings.notify_downtime : true
  };
  document.querySelectorAll('#notificationPrefs input[type="checkbox"]').forEach(input => {
    const key = input.getAttribute('data-pref');
    input.checked = !!notifPrefs[key];
    const label = input.parentElement.querySelector('.pref-label');
    label.textContent = input.checked ? 'ON' : 'OFF';
    input.disabled = false;
    // Add unsaved state trigger
    input.addEventListener('change', () => setUnsaved(true));
  });
  updateSaveBtnState(); // Ensure Save button state is correct after loading
}

// On page load, always call loadUserSettings to prefill fields
window.addEventListener('DOMContentLoaded', function() {
  loadUserSettings();
});

// --- Populate timezone dropdown with major English-speaking region timezones only ---
function populateTimezoneDropdown() {
  const tzSelect = document.getElementById('timezoneSelect');
  tzSelect.innerHTML = '';
  const timezoneOptions = [
    { value: 'GMT', label: 'GMT (Greenwich Mean Time)' },
    { value: 'BST', label: 'BST (British Summer Time)' },
    { value: 'EST', label: 'EST (Eastern Time US & Canada)' },
    { value: 'CST', label: 'CST (Central Time US & Canada)' },
    { value: 'MST', label: 'MST (Mountain Time US & Canada)' },
    { value: 'PST', label: 'PST (Pacific Time US & Canada)' },
    { value: 'AST', label: 'AST (Atlantic Time Canada)' },
    { value: 'AEST', label: 'AEST (Australian Eastern Standard Time)' },
    { value: 'AEDT', label: 'AEDT (Australian Eastern Daylight Time)' },
    { value: 'ACST', label: 'ACST (Australian Central Standard Time)' },
    { value: 'AWST', label: 'AWST (Australian Western Standard Time)' },
    { value: 'NZST', label: 'NZST (New Zealand Standard Time)' },
    { value: 'HST', label: 'HST (Hawaii Standard Time)' },
    { value: 'AKST', label: 'AKST (Alaska Standard Time)' }
  ];
  timezoneOptions.forEach(opt => {
    const option = document.createElement('option');
    option.value = opt.value;
    option.textContent = opt.label;
    tzSelect.appendChild(option);
  });
}

// --- Only save timezone to DB when Save All Changes is clicked (not on change) ---
document.getElementById('saveAllBtn').addEventListener('click', async function(e) {
  e.preventDefault();

  // Required fields validation
  const fullNameVal = document.getElementById('profileFullName').value.trim();
  const companyVal = document.getElementById('profileCompany').value.trim();
  const phoneVal = document.getElementById('profilePhone').value.trim();
  const saveMsg = document.getElementById('saveAllMsg');
  if (!fullNameVal || !companyVal || phoneVal.length < 10) {
    saveMsg.textContent = 'Please fill in all required fields appropriately.';
    saveMsg.style.color = 'red';
    if (phoneVal.length < 10 && typeof showPhoneErrorModal === 'function') showPhoneErrorModal();
    return;
  }

  // Ensure user_profiles and user_settings rows exist before saving
  const profileExists = await supabase.from('user_profiles').select('id').eq('user_id', user.id).maybeSingle();
  if (!profileExists.data) {
    await supabase.from('user_profiles').insert({ user_id: user.id });
  }
  const settingsExists = await supabase.from('user_settings').select('id').eq('user_id', user.id).maybeSingle();
  if (!settingsExists.data) {
    await supabase.from('user_settings').insert({ user_id: user.id });
  }

  // Use temporarilyDisableBeforeUnload for smooth UX
  temporarilyDisableBeforeUnload(async () => {
    // Notification preferences
    const notificationPrefs = {
      notify_weekly: document.querySelector('input[data-pref="weekly"]').checked,
      notify_automation: document.querySelector('input[data-pref="automation"]').checked,
      notify_features: document.querySelector('input[data-pref="features"]').checked,
      notify_billing: document.querySelector('input[data-pref="billing"]').checked,
      notify_downtime: document.querySelector('input[data-pref="downtime"]').checked,
    };

    // Profile info
    const profileUpdates = {
      full_name: fullNameVal,
      company: companyVal,
      phone: phoneVal,
    };

    // Settings info
    const settingsUpdates = {
      timezone: document.getElementById('timezoneSelect').value,
      language: document.getElementById('languageSelect').value,
      dark_mode: document.getElementById('darkModeToggle').checked,
      font_size: document.getElementById('fontSizeSelect').value,
      ...notificationPrefs
    };

    // Clear previous error message before starting save
    saveMsg.textContent = '';

    // Update user_profiles
    const { error: profileError } = await supabase
      .from('user_profiles')
      .update(profileUpdates)
      .eq('user_id', user.id);

    // Update user_settings
    const { error: settingsError } = await supabase
      .from('user_settings')
      .update(settingsUpdates)
      .eq('user_id', user.id);

    if (profileError || settingsError) {
      saveMsg.textContent = 'Error saving: ' + (profileError?.message || settingsError?.message);
      saveMsg.style.color = 'red';
    } else {
      saveMsg.textContent = 'All changes saved!';
      saveMsg.style.color = 'green';
      setUnsaved(false);
      await loadUserSettings();
      // Optionally show a green save banner and log activity
      if (typeof showSaveBanner === 'function') showSaveBanner();
      if (typeof logActivity === 'function') await logActivity('Updated profile/settings');
    }
    setTimeout(() => { saveMsg.textContent = ''; }, 2000);
  });
});

// --- Load Activity Log ---
async function loadActivityLog() {
  const { data, error } = await supabase
    .from('activity_log')
    .select('*')
    .eq('user_id', user.id)
    .order('created_at', { ascending: false }) // Most recent at the top
    .limit(30); // Limit to latest 30
  const logList = document.getElementById('activityLog');
  logList.innerHTML = '';
  if (error || !data || data.length === 0) {
    logList.innerHTML = '<li class="text-gray-400">No recent activity found.</li>';
    return;
  }
  data.forEach(item => {
    const li = document.createElement('li');
    li.innerHTML = `${getDeviceIcon(item.device)} <span>${item.event}</span> <span class="text-gray-400 ml-1">(${parseDeviceInfo(item.device)})</span> <span class="text-gray-400 ml-1">- ${new Date(item.created_at).toLocaleString()}</span>`;
    logList.appendChild(li);
  });
}
// --- Load Sessions ---
async function loadSessions() {
  const { data, error } = await supabase
    .from('sessions')
    .select('*')
    .eq('user_id', user.id)
    .order('last_active', { ascending: false });
  const sessionList = document.getElementById('sessionList');
  sessionList.innerHTML = '';
  if (error || !data || data.length === 0) {
    sessionList.innerHTML = '<li class="text-gray-400">No active sessions found.</li>';
    return;
  }
  // Deduplicate by device+user agent (keep most recent per device)
  const seen = new Set();
  const deduped = [];
  for (const session of data) {
    const key = session.device || 'unknown';
    if (!seen.has(key)) {
      seen.add(key);
      deduped.push(session);
    }
  }
  // Limit to latest 30 deduped sessions
  deduped.slice(0, 30).forEach(session => {
    const li = document.createElement('li');
    li.innerHTML = `${getDeviceIcon(session.device)} <span>${parseDeviceInfo(session.device)}</span> <span class="text-gray-400 ml-2">${session.is_current ? 'Current' : ''}</span> <button class="btn-secondary ml-2" onclick="logoutSession('${session.id}')">Log Out</button>`;
    sessionList.appendChild(li);
  });
}
// --- Device icon and info helpers ---
function getDeviceIcon(deviceStr) {
  if (!deviceStr) return '<svg style="vertical-align:middle;opacity:0.7;" width="18" height="18" fill="none" stroke="#64748b" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="13" rx="2"/><path d="M8 21v-4h8v4"/><path d="M12 11v-4"/></svg>';
  if (/mobile|android|iphone|ipad|ipod/i.test(deviceStr)) {
    return '<svg style="vertical-align:middle;opacity:0.7;" width="18" height="18" fill="none" stroke="#3b82f6" stroke-width="2" viewBox="0 0 24 24"><rect x="7" y="2" width="10" height="20" rx="2"/><circle cx="12" cy="18" r="1.5"/></svg>';
  }
  if (/windows|macintosh|linux/i.test(deviceStr)) {
    return '<svg style="vertical-align:middle;opacity:0.7;" width="18" height="18" fill="none" stroke="#6366f1" stroke-width="2" viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="14" rx="2"/><path d="M8 20h8"/></svg>';
  }
  return '<svg style="vertical-align:middle;opacity:0.7;" width="18" height="18" fill="none" stroke="#64748b" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="13" rx="2"/><path d="M8 21v-4h8v4"/><path d="M12 11v-4"/></svg>';
}
function parseDeviceInfo(deviceStr) {
  if (!deviceStr) return 'Unknown device';
  // Try to extract OS and browser
  let os = 'Unknown OS', browser = 'Unknown browser';
  if (/windows/i.test(deviceStr)) os = 'Windows';
  else if (/macintosh/i.test(deviceStr)) os = 'Mac';
  else if (/linux/i.test(deviceStr)) os = 'Linux';
  else if (/android/i.test(deviceStr)) os = 'Android';
  else if (/iphone|ipad|ipod/i.test(deviceStr)) os = 'iOS';
  if (/chrome\//i.test(deviceStr)) browser = 'Chrome';
  else if (/safari\//i.test(deviceStr)) browser = 'Safari';
  else if (/firefox\//i.test(deviceStr)) browser = 'Firefox';
  else if (/edg\//i.test(deviceStr)) browser = 'Edge';
  else if (/opera|opr\//i.test(deviceStr)) browser = 'Opera';
  return `${os}, ${browser}`;
}
// --- Log out a session ---
window.logoutSession = async function(sessionId) {
  const { error } = await supabase
    .from('sessions')
    .delete()
    .eq('id', sessionId);
  if (error) alert('Failed to log out session');
  else loadSessions();
};

// --- Custom Delete Account Modal Flow ---
function showDeletePasswordModal(onPassword) {
  if (document.getElementById('deleteModalOverlay')) return;
  const html = `
    <div id="deleteModalOverlay" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(30,41,59,0.45);z-index:9999;display:flex;align-items:center;justify-content:center;animation:fadeInModal 0.25s;">
      <div style="background:white;padding:2.5rem 2rem 2rem 2rem;border-radius:1.2rem;box-shadow:0 8px 32px rgba(30,41,59,0.18);min-width:320px;max-width:90vw;text-align:center;animation:fadeInModal 0.25s;">
        <h2 style='color:#ef4444;font-size:1.3rem;font-weight:700;margin-bottom:1rem;'>${i18n[localStorage.getItem('gmt_lang') || 'en'].deleteTitle}</h2>
        <p style='color:#374151;font-size:1rem;margin-bottom:1.5rem;'>${i18n[localStorage.getItem('gmt_lang') || 'en'].deletePwPrompt}</p>
        <input id='deletePwInput' type='password' placeholder='Password' style='padding:0.7rem 1rem;border-radius:0.75rem;border:1.5px solid #ddd;width:90%;margin-bottom:1.5rem;font-size:1rem;'>
        <div id='deletePwError' style='color:#ef4444;font-size:0.95rem;margin-bottom:1rem;display:none;'></div>
        <div style='display:flex;gap:1.5rem;justify-content:center;'>
          <button id='deletePwConfirmBtn' style='background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:white;padding:0.7rem 1.5rem;border:none;border-radius:0.75rem;font-weight:600;cursor:pointer;'>${i18n[localStorage.getItem('gmt_lang') || 'en'].confirm}</button>
          <button id='deletePwCancelBtn' style='background:#f3f4f6;color:#374151;padding:0.7rem 1.5rem;border:none;border-radius:0.75rem;font-weight:600;cursor:pointer;'>${i18n[localStorage.getItem('gmt_lang') || 'en'].cancel}</button>
        </div>
      </div>
    </div>
    <style>@keyframes fadeInModal{from{opacity:0;transform:translateY(24px);}to{opacity:1;transform:none;}}</style>
  `;
  document.body.insertAdjacentHTML('beforeend', html);
  document.getElementById('deletePwCancelBtn').onclick = function() {
    closeDeleteModal();
  };
  document.getElementById('deletePwConfirmBtn').onclick = function() {
    const pw = document.getElementById('deletePwInput').value;
    if (!pw) {
      const err = document.getElementById('deletePwError');
      err.textContent = i18n[localStorage.getItem('gmt_lang') || 'en'].requiredPw;
      err.style.display = '';
      return;
    }
    onPassword(pw);
  };
}
function showDeleteAutomationsModal(company, email, onYes, onNo) {
  if (document.getElementById('deleteModalOverlay')) closeDeleteModal();
  const html = `
    <div id="deleteModalOverlay" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(30,41,59,0.45);z-index:9999;display:flex;align-items:center;justify-content:center;animation:fadeInModal 0.25s;">
      <div style="background:white;padding:2.5rem 2rem 2rem 2rem;border-radius:1.2rem;box-shadow:0 8px 32px rgba(30,41,59,0.18);min-width:320px;max-width:90vw;text-align:center;animation:fadeInModal 0.25s;">
        <h2 style='color:#ef4444;font-size:1.2rem;font-weight:700;margin-bottom:1rem;'>${i18n[localStorage.getItem('gmt_lang') || 'en'].deleteAutoTitle}</h2>
        <p style='color:#374151;font-size:1rem;margin-bottom:1.5rem;'>
          ${i18n[localStorage.getItem('gmt_lang') || 'en'].deleteAutoMsg}
          <b>${company}</b><br>
          <span style="color:#2563eb;font-size:0.98rem;">${email}</span>
        </p>
        <div style='display:flex;gap:1.5rem;justify-content:center;'>
          <button id='deleteAutoYesBtn' style='background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:white;padding:0.7rem 1.5rem;border:none;border-radius:0.75rem;font-weight:600;cursor:pointer;'>${i18n[localStorage.getItem('gmt_lang') || 'en'].yes}</button>
          <button id='deleteAutoNoBtn' style='background:#f3f4f6;color:#374151;padding:0.7rem 1.5rem;border:none;border-radius:0.75rem;font-weight:600;cursor:pointer;'>${i18n[localStorage.getItem('gmt_lang') || 'en'].no}</button>
        </div>
      </div>
    </div>
    <style>@keyframes fadeInModal{from{opacity:0;transform:translateY(24px);}to{opacity:1;transform:none;}}</style>
  `;
  document.body.insertAdjacentHTML('beforeend', html);
  document.getElementById('deleteAutoYesBtn').onclick = function() { onYes(); };
  document.getElementById('deleteAutoNoBtn').onclick = function() { closeDeleteModal(); };
}
function showDeleteReviewModal() {
  if (document.getElementById('deleteModalOverlay')) closeDeleteModal();
  const html = `
    <div id="deleteModalOverlay" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(30,41,59,0.45);z-index:9999;display:flex;align-items:center;justify-content:center;animation:fadeInModal 0.25s;">
      <div style="background:white;padding:2.5rem 2rem 2rem 2rem;border-radius:1.2rem;box-shadow:0 8px 32px rgba(30,41,59,0.18);min-width:320px;max-width:90vw;text-align:center;animation:fadeInModal 0.25s;">
        <h2 style='color:#ef4444;font-size:1.2rem;font-weight:700;margin-bottom:1rem;'>Account Deletion Requested</h2>
        <p style='color:#374151;font-size:1rem;margin-bottom:1.5rem;'>Your account is being reviewed before proper deletion. You will be notified when the process is complete.</p>
        <button id="deleteReviewCloseBtn" style="background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:white;padding:0.7rem 1.5rem;border:none;border-radius:0.75rem;font-weight:600;cursor:pointer;">Close</button>
      </div>
    </div>
    <style>@keyframes fadeInModal{from{opacity:0;transform:translateY(24px);}to{opacity:1;transform:none;}}</style>
  `;
  document.body.insertAdjacentHTML('beforeend', html);
  document.getElementById('deleteReviewCloseBtn').onclick = function() {
    closeDeleteModal();
    // Show additional explanation modal
    const msgHtml = `
      <div id="deletePausedOverlay" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(30,41,59,0.45);z-index:10000;display:flex;align-items:center;justify-content:center;animation:fadeInModal 0.25s;">
        <div style="background:white;padding:2.2rem 2rem 2rem 2rem;border-radius:1.2rem;box-shadow:0 8px 32px rgba(30,41,59,0.18);min-width:320px;max-width:90vw;text-align:center;animation:fadeInModal 0.25s;">
          <h2 style='color:#ef4444;font-size:1.1rem;font-weight:700;margin-bottom:1rem;'>Access Paused</h2>
          <p style='color:#374151;font-size:1rem;margin-bottom:1.5rem;'>To protect your data and make sure this request is processed correctly, we've paused your access until our team follows up. No more than three business days.</p>
          <button id="deletePausedCloseBtn" style="background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:white;padding:0.7rem 1.5rem;border:none;border-radius:0.75rem;font-weight:600;cursor:pointer;">Close</button>
        </div>
      </div>
      <style>@keyframes fadeInModal{from{opacity:0;transform:translateY(24px);}to{opacity:1;transform:none;}}</style>
    `;
    document.body.insertAdjacentHTML('beforeend', msgHtml);
    document.getElementById('deletePausedCloseBtn').onclick = function() {
      const overlay = document.getElementById('deletePausedOverlay');
      if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
      // Redirect to login (relative path for production)
      window.location.href = '../../login/login.html';
    };
  };
}
function closeDeleteModal() {
  const overlay = document.getElementById('deleteModalOverlay');
  if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
}

document.getElementById('deleteAccountBtn').addEventListener('click', async function() {
  showDeletePasswordModal(async function(pw) {
    // Debug: print the email being checked
    console.log('Checking password for email:', user.email);

    // Query the user by email
    const { data, error } = await supabase
      .from('users')
      .select('password_hash')
      .eq('email', user.email)
      .single();

    // Debug: print the result
    console.log('User data:', data);

    // Handle errors or missing user
    if (error || !data || !data.password_hash) {
      document.getElementById('deletePwError').textContent = 'Could not verify password.';
      document.getElementById('deletePwError').style.display = '';
      return;
    }

    // Compare entered password to password_hash
    if (data.password_hash !== pw) {
      document.getElementById('deletePwError').textContent = 'Incorrect password.';
      document.getElementById('deletePwError').style.display = '';
      return;
    }

    // If correct, proceed with deletion request
    // Fetch company and email from the profile form fields
    const company = document.getElementById('profileCompany').value || 'N/A';
    const email = document.getElementById('profileEmail').value || user.email || 'N/A';

    closeDeleteModal();
    showDeleteAutomationsModal(company, email, async function() {
      // Mark for deletion review
      await supabase.from('users').update({ deletion_requested: true }).eq('email', user.email);
      closeDeleteModal();
      showDeleteReviewModal();
    }, function() {
      closeDeleteModal();
    });
  });
});

document.getElementById('passwordForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const currentPw = document.getElementById('currentPassword').value;
  const newPw = document.getElementById('newPassword').value;
  const confirmPw = document.getElementById('confirmNewPassword').value;
  const msgEl = document.getElementById('passwordMsg');
  msgEl.textContent = '';
  if (!currentPw || !newPw || !confirmPw) {
    msgEl.textContent = 'Please fill in all fields.';
    msgEl.style.color = 'red';
    return;
  }
  if (newPw !== confirmPw) {
    msgEl.textContent = 'New passwords do not match.';
    msgEl.style.color = 'red';
    return;
  }
  // Verify current password
  const { data, error } = await supabase
    .from('users')
    .select('password_hash')
    .eq('email', user.email)
    .single();
  console.log('User data:', data);
  console.log('DB password_hash:', data ? data.password_hash : null);
  console.log('Entered password:', currentPw);
  if (error || !data || !data.password_hash) {
    msgEl.textContent = 'Could not verify current password.';
    msgEl.style.color = 'red';
    return;
  }
  if (data.password_hash !== currentPw) {
    msgEl.textContent = 'Current password is incorrect.';
    msgEl.style.color = 'red';
    return;
  }
  // Update password
  const { error: updateError } = await supabase
    .from('users')
    .update({ password_hash: newPw })
    .eq('email', user.email);
  if (updateError) {
    msgEl.textContent = 'Failed to update password.';
    msgEl.style.color = 'red';
  } else {
    msgEl.textContent = 'Password updated successfully!';
    msgEl.style.color = 'green';
    document.getElementById('currentPassword').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmNewPassword').value = '';
  }
});

// --- Delete Account Modal logic ---
// Remove beforeunload event to prevent browser alert
window.onbeforeunload = null;

async function ensureSessionAndActivity() {
  const device = navigator.userAgent;
  // Try to find a session for this user/device
  let { data, error } = await supabase
    .from('sessions')
    .select('*')
    .eq('user_id', user.id)
    .eq('device', device)
    .maybeSingle();
  if (!data) {
    // Insert a new session
    const { error: insertErr } = await supabase.from('sessions').insert({
      user_id: user.id,
      device: device,
      is_current: true,
      last_active: new Date().toISOString()
    });
    if (insertErr) console.error('Session insert error:', insertErr);
  } else {
    // Update last_active and is_current
    const { error: updateErr } = await supabase.from('sessions').update({
      last_active: new Date().toISOString(),
      is_current: true
    }).eq('id', data.id);
    if (updateErr) console.error('Session update error:', updateErr);
  }
  // Log a 'Viewed settings' event to activity_log on page load
  const { error: logErr } = await supabase.from('activity_log').insert({
    user_id: user.id,
    event: 'Viewed settings',
    device: device,
    created_at: new Date().toISOString()
  });
  if (logErr) console.error('Activity log insert error:', logErr);
  // After ensuring, reload lists
  await loadSessions();
  await loadActivityLog();
}
// On page load, ensure session/activity and reload lists
ensureSessionAndActivity();

// --- Update unsaved changes modal buttons for correct save and hover mechanics ---
// --- Update Save button in unsaved changes modal to be inverse (pale blue, blue text, no border) ---
const modalHtml = `
  <div id="unsavedModalOverlay" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(30,41,59,0.45);z-index:9999;display:flex;align-items:center;justify-content:center;animation:fadeInModal 0.25s;">
    <div id="unsavedModal" style="background:white;padding:2.5rem 2rem 2rem 2rem;border-radius:1.2rem;box-shadow:0 8px 32px rgba(30,41,59,0.18);min-width:320px;max-width:90vw;text-align:center;animation:fadeInModal 0.25s;">
      <h2 style='color:#172554;font-size:1.3rem;font-weight:700;margin-bottom:1rem;'>${i18n[localStorage.getItem('gmt_lang') || 'en'].unsavedModalTitle}</h2>
      <p style='color:#374151;font-size:1rem;margin-bottom:2rem;'>${i18n[localStorage.getItem('gmt_lang') || 'en'].unsavedModalMsg}</p>
      <div style='display:flex;gap:1.5rem;justify-content:center;'>
        <button id="unsavedModalSaveBtn" class="unsaved-modal-btn" style="background:#f1f5fd;color:#2563eb;padding:0.7rem 1.5rem;border:none;border-radius:0.75rem;font-weight:600;cursor:pointer;transition:all 0.2s;">${i18n[localStorage.getItem('gmt_lang') || 'en'].save}</button>
        <button id="unsavedModalLeaveBtn" class="unsaved-modal-btn" style="background:#fef2f2;color:#ef4444;padding:0.7rem 1.5rem;border:none;border-radius:0.75rem;font-weight:600;cursor:pointer;transition:all 0.2s;">${i18n[localStorage.getItem('gmt_lang') || 'en'].leaveWithoutSaving}</button>
      </div>
    </div>
  </div>
  <style>
    @keyframes fadeInModal{from{opacity:0;transform:translateY(24px);}to{opacity:1;transform:none;}}
    #unsavedModalSaveBtn.unsaved-modal-btn:hover {
      background: #2563eb !important;
      color: #fff !important;
      box-shadow: 0 2px 8px rgba(37,99,235,0.10);
      transform: translateY(-2px) scale(1.04);
    }
    #unsavedModalSaveBtn.unsaved-modal-btn {
      background: #f1f5fd;
      color: #2563eb;
    }
    #unsavedModalLeaveBtn.unsaved-modal-btn:hover {
      background: #ef4444 !important;
      color: #fff !important;
      box-shadow: 0 2px 8px rgba(239,68,68,0.13);
      transform: translateY(-2px) scale(1.04);
    }
    #unsavedModalLeaveBtn.unsaved-modal-btn {
      background: #fef2f2;
      color: #ef4444;
    }
  </style>
`;

// --- Robust beforeunload and modal logic ---
// Only set beforeunload if unsaved and NOT interacting with modal
function enableBeforeUnload() {
  window.onbeforeunload = function(e) {
    if (unsaved && !document.getElementById('unsavedModalOverlay')) {
      e.preventDefault();
      e.returnValue = '';
      return '';
    }
  };
}
function disableBeforeUnload() {
  window.onbeforeunload = null;
}

// Always enable beforeunload when unsaved, except when modal is open
setInterval(() => {
  if (unsaved && !document.getElementById('unsavedModalOverlay')) {
    enableBeforeUnload();
  } else {
    disableBeforeUnload();
  }
}, 200);

// --- Update modal logic ---
// --- Fix Save button in modal: close modal, show banner, then navigate after fade ---
function showUnsavedModal(onSave, onLeave) {
  if (document.getElementById('unsavedModalOverlay')) return;
  disableBeforeUnload();
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  document.getElementById('unsavedModalSaveBtn').onclick = async function() {
    disableBeforeUnload();
    await document.getElementById('saveAllBtn').click();
    showSaveBanner();
    // After banner fades, close modal and navigate
    if (onSave) setTimeout(() => { closeUnsavedModal(); onSave(); }, 2100);
  };
  document.getElementById('unsavedModalLeaveBtn').onclick = function() {
    disableBeforeUnload();
    setUnsaved(false); // Mark as not unsaved so beforeunload never triggers
    closeUnsavedModal();
    if (onLeave) onLeave();
  };
}

// --- Intercept navigation (links) ---
// --- Use event delegation for ALL <a> clicks, including sidebar and dynamic links ---
document.addEventListener('click', function(e) {
  const a = e.target.closest('a');
  if (a && a.getAttribute('href') && a.getAttribute('href').charAt(0) !== '#') {
    if (unsaved) {
      e.preventDefault();
      pendingNavigationHref = a.getAttribute('href');
      showUnsavedModal(
        () => { window.location.href = pendingNavigationHref; },
        () => { setUnsaved(false); window.location.href = pendingNavigationHref; }
      );
    }
  }
});

// --- Intercept browser tab close/reload ---
window.addEventListener('beforeunload', function(e) {
  if (unsaved) {
    e.preventDefault();
    e.returnValue = '';
    showUnsavedModal(
      () => { window.removeEventListener('beforeunload', arguments.callee); window.location.reload(); },
      () => { window.removeEventListener('beforeunload', arguments.callee); }
    );
    return '';
  }
});

// --- Intercept browser back/forward navigation (SPA or history) ---
window.addEventListener('popstate', function(e) {
  if (unsaved) {
    e.preventDefault();
    pendingNavigationEvent = e;
    showUnsavedModal(
      () => { history.go(-1); },
      () => { history.go(-1); }
    );
  }
});

// --- Ensure unsaved state is set on any input/change ---
['profileFullName','profileCompany','profilePhone','timezoneSelect','languageSelect','fontSizeSelect'].forEach(id => {
  document.getElementById(id).addEventListener('input', () => setUnsaved(true));
  document.getElementById(id).addEventListener('change', () => setUnsaved(true));
});
document.getElementById('darkModeToggle').addEventListener('change', () => setUnsaved(true));

// --- Fix navigation modal for ALL links, including sidebar nav ---
document.querySelectorAll('a').forEach(link => {
  link.addEventListener('click', function(e) {
    if (this.getAttribute('href') && this.getAttribute('href').charAt(0) !== '#') {
      if (unsaved) {
        e.preventDefault();
        pendingNavigationHref = this.getAttribute('href');
        showUnsavedModal(
          () => { window.location.href = pendingNavigationHref; },
          () => { window.location.href = pendingNavigationHref; }
        );
      }
    }
  });
});

// --- Unsaved state tracking ---
let unsaved = false;
function setUnsaved(val) {
  unsaved = val;
  const msg = document.getElementById('unsavedMsg');
  if (msg) msg.style.display = val ? '' : 'none';
}

// --- Remove beforeunload alert when saving ---
function temporarilyDisableBeforeUnload(callback) {
  const handler = window.onbeforeunload;
  window.onbeforeunload = null;
  callback();
  setTimeout(() => { window.onbeforeunload = handler; }, 100);
}

// --- Show green info banner on save ---
function showSaveBanner() {
  if (document.getElementById('saveBanner')) return;
  const banner = document.createElement('div');
  banner.id = 'saveBanner';
  banner.textContent = 'Changes have been saved.';
  banner.style.position = 'fixed';
  banner.style.top = '0';
  banner.style.left = '0';
  banner.style.width = '100vw';
  banner.style.background = 'linear-gradient(90deg,#22c55e 0%,#16a34a 100%)';
  banner.style.color = 'white';
  banner.style.fontWeight = '600';
  banner.style.fontSize = '1.1rem';
  banner.style.textAlign = 'center';
  banner.style.padding = '1rem 0';
  banner.style.zIndex = '99999';
  banner.style.boxShadow = '0 2px 8px rgba(34,197,94,0.15)';
  banner.style.opacity = '0';
  banner.style.transition = 'opacity 0.3s';
  document.body.appendChild(banner);
  setTimeout(() => { banner.style.opacity = '1'; }, 10);
  setTimeout(() => {
    banner.style.opacity = '0';
    setTimeout(() => { if (banner.parentNode) banner.parentNode.removeChild(banner); }, 400);
  }, 2000);
}

// --- Phone number input: only allow numbers, ignore dashes/spaces, min 10 digits ---
const phoneInput = document.getElementById('profilePhone');
// --- Live phone number validation error message (bold, always underneath) ---
let phoneError = document.getElementById('phoneErrorMsg');
if (!phoneError) {
  phoneError = document.createElement('div');
  phoneError.id = 'phoneErrorMsg';
  phoneError.style.color = 'red';
  phoneError.style.fontWeight = '600';
  phoneError.style.fontSize = '1rem';
  phoneError.style.marginTop = '0.3rem';
  phoneError.style.marginBottom = '0.7rem';
  phoneError.style.display = 'none';
  const phoneField = document.getElementById('profilePhone');
  phoneField.parentNode.insertBefore(phoneError, phoneField.nextSibling);
}
phoneInput.addEventListener('input', function(e) {
  let val = this.value.replace(/[^0-9]/g, '');
  this.value = val;
  if (val.length > 0 && val.length < 10) {
    phoneError.textContent = i18n[localStorage.getItem('gmt_lang') || 'en'].phoneError;
    phoneError.style.display = '';
  } else {
    phoneError.textContent = '';
    phoneError.style.display = 'none';
  }
});

// --- Custom modal for phone number validation error ---
function showPhoneErrorModal() {
  if (document.getElementById('phoneModalOverlay')) return;
  const html = `
    <div id="phoneModalOverlay" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(30,41,59,0.45);z-index:99999;display:flex;align-items:center;justify-content:center;animation:fadeInModal 0.25s;">
      <div style="background:white;padding:2.2rem 2rem 2rem 2rem;border-radius:1.2rem;box-shadow:0 8px 32px rgba(30,41,59,0.18);min-width:320px;max-width:90vw;text-align:center;animation:fadeInModal 0.25s;">
        <h2 style='color:#ef4444;font-size:1.1rem;font-weight:700;margin-bottom:1rem;'>${i18n[localStorage.getItem('gmt_lang') || 'en'].phoneModalTitle}</h2>
        <p style='color:#374151;font-size:1rem;margin-bottom:1.5rem;'>${i18n[localStorage.getItem('gmt_lang') || 'en'].phoneModalMsg}</p>
        <button id='phoneModalOkBtn' style='background:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%);color:white;padding:0.7rem 1.5rem;border:none;border-radius:0.75rem;font-weight:600;cursor:pointer;'>${i18n[localStorage.getItem('gmt_lang') || 'en'].close}</button>
      </div>
    </div>
    <style>@keyframes fadeInModal{from{opacity:0;transform:translateY(24px);}to{opacity:1;transform:none;}}</style>
  `;
  document.body.insertAdjacentHTML('beforeend', html);
  document.getElementById('phoneModalOkBtn').onclick = function() {
    const overlay = document.getElementById('phoneModalOverlay');
    if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
  };
}

// --- Block unsaved changes modal and saving if phone number is invalid ---
function isPhoneValid() {
  const phoneVal = document.getElementById('profilePhone').value;
  return phoneVal.length >= 10;
}

// Patch navigation interception for unsaved changes
const originalShowUnsavedModal = showUnsavedModal;
showUnsavedModal = function(onSave, onLeave) {
  if (!isPhoneValid()) {
    showPhoneErrorModal();
    return;
  }
  originalShowUnsavedModal(onSave, onLeave);
};

// --- Disable Save All Changes button if phone number is invalid ---
function updateSaveBtnState() {
  const btn = document.getElementById('saveAllBtn');
  const phoneVal = document.getElementById('profilePhone').value;
  const disabledMsg = document.getElementById('saveAllDisabledMsg');
  if (phoneVal.length < 10) {
    btn.disabled = true;
    btn.style.opacity = '0.5';
    btn.style.cursor = 'not-allowed';
    if (disabledMsg) disabledMsg.style.display = '';
  } else {
    btn.disabled = false;
    btn.style.opacity = '1';
    btn.style.cursor = 'pointer';
    if (disabledMsg) disabledMsg.style.display = 'none';
  }
}
phoneInput.addEventListener('input', updateSaveBtnState);
window.addEventListener('DOMContentLoaded', updateSaveBtnState);

// --- Font size logic: apply live on change ---
function applyFontSize(size) {
  let px = '16px';
  if (size === 'Small') px = '13px';
  else if (size === 'Normal') px = '16px';
  else if (size === 'Large') px = '19px';
  else if (size === 'Extra Large') px = '22px';
  document.documentElement.style.fontSize = px;
}

document.getElementById('fontSizeSelect').addEventListener('change', function() {
  applyFontSize(this.value);
  setUnsaved(true);
});

// --- Ensure font size starts at Normal unless set in Supabase ---
// (No need to set font size on DOMContentLoaded, loadUserSettings handles it)

// --- Utility: Log activity events ---
async function logActivity(event) {
  await supabase.from('activity_log').insert({
    user_id: user.id,
    event: event,
    device: navigator.userAgent,
    created_at: new Date().toISOString()
  });
}

function closeUnsavedModal() {
  const overlay = document.getElementById('unsavedModalOverlay');
  if (overlay && overlay.parentNode) {
    overlay.parentNode.removeChild(overlay);
    console.log('Unsaved modal closed');
  }
}

// --- Patch: Ensure user.id is always present in session ---
async function ensureUserIdInSession() {
  let userObj = JSON.parse(localStorage.getItem('gmt_user')) || JSON.parse(sessionStorage.getItem('gmt_user'));
  if (userObj && !userObj.id && userObj.email) {
    // Fetch user from Supabase
    const { data, error } = await supabase.from('users').select('id').eq('email', userObj.email).single();
    if (data && data.id) {
      userObj.id = data.id;
      if (localStorage.getItem('gmt_user')) {
        localStorage.setItem('gmt_user', JSON.stringify(userObj));
      } else {
        sessionStorage.setItem('gmt_user', JSON.stringify(userObj));
      }
      // Reload page to use new id
      window.location.reload();
    }
  }
}
window.addEventListener('DOMContentLoaded', ensureUserIdInSession);

var manageBillingBtn = document.getElementById('manageBillingBtn');
if (manageBillingBtn) {
  manageBillingBtn.addEventListener('click', function() {
    // TODO: Replace with your real Stripe Billing Portal session URL logic
    window.location.href = 'https://billing.stripe.com/p/login/test_billing_portal';
  });
}

async function loadBillingInfo() {
  // TODO: Replace with logic to get the user's Stripe customer ID from Supabase/session
  const customerId = window.gmt_stripe_customer_id || '';
  if (!customerId) {
    document.getElementById('billingInfo').textContent = 'Billing info unavailable.';
    return;
  }
  try {
    const res = await fetch(`/api/billing-info?customerId=${customerId}`);
    const data = await res.json();
    if (data.error) {
      document.getElementById('billingInfo').textContent = 'Unable to load billing info.';
      return;
    }
    document.getElementById('billingInfo').innerHTML = `
      <div><b>Next Payment:</b> $${data.amount_due} ${data.currency} on ${data.due_date}</div>
      <div><b>Status:</b> ${data.status.charAt(0).toUpperCase() + data.status.slice(1)}</div>
    `;
  } catch (e) {
    document.getElementById('billingInfo').textContent = 'Unable to load billing info.';
  }
}
window.addEventListener('DOMContentLoaded', loadBillingInfo);

// Add sign out logic
document.addEventListener('DOMContentLoaded', function() {
  const signOutBtn = document.getElementById('signOutBtn');
  const isFileProtocol = window.location.protocol === 'file:';
  if (signOutBtn) {
    signOutBtn.addEventListener('click', function() {
      console.log('Sign out button clicked');
      const user = JSON.parse(localStorage.getItem('gmt_user')) || JSON.parse(sessionStorage.getItem('gmt_user'));
      console.log('User object at sign out:', user);
      try {
        if (user && user.id && typeof logActivity === 'function') logActivity('Logged out');
        localStorage.removeItem('gmt_user');
        sessionStorage.removeItem('gmt_user');
        sessionStorage.removeItem('gmt_logged_in');
        console.log('Session and local storage cleared. Redirecting...');
        if (isFileProtocol) {
          window.location.href = '../login/login.html';
        } else {
          window.location.href = '/client/login/login.html';
        }
      } catch (err) {
        console.error('Error during sign out:', err);
      }
    });
  } else {
    console.error('Sign out button not found in DOM');
  }
});

// Robust sign out handler attachment (polling approach)
(function attachSignOutHandler() {
  var tries = 0;
  function tryAttach() {
    var signOutBtn = document.getElementById('signOutBtn');
    if (signOutBtn) {
      signOutBtn.addEventListener('click', function() {
        const user = JSON.parse(localStorage.getItem('gmt_user')) || JSON.parse(sessionStorage.getItem('gmt_user'));
        if (user && user.id && typeof logActivity === 'function') logActivity('Logged out');
        localStorage.removeItem('gmt_user');
        sessionStorage.removeItem('gmt_user');
        sessionStorage.removeItem('gmt_logged_in');
        if (window.location.protocol === 'file:') {
          window.location.href = '../login/login.html';
        } else {
          window.location.href = '/client/login/login.html';
        }
      });
      console.log('Sign out handler attached');
    } else if (tries < 20) {
      tries++;
      setTimeout(tryAttach, 100);
    } else {
      console.error('Sign out button not found after multiple attempts');
    }
  }
  tryAttach();
})();

// Robust sidebar sign out handler attachment (polling approach)
(function attachSidebarSignOutHandler() {
  var tries = 0;
  function tryAttach() {
    var logoutBtn = document.getElementById('userLogout');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', function() {
        const user = JSON.parse(localStorage.getItem('gmt_user')) || JSON.parse(sessionStorage.getItem('gmt_user'));
        if (user && user.id && typeof logActivity === 'function') logActivity('Logged out');
        localStorage.removeItem('gmt_user');
        sessionStorage.removeItem('gmt_user');
        sessionStorage.removeItem('gmt_logged_in');
        if (window.location.protocol === 'file:') {
          window.location.href = '../login/login.html';
        } else {
          window.location.href = '/client/login/login.html';
        }
      });
      console.log('Sidebar sign out handler attached');
    } else if (tries < 20) {
      tries++;
      setTimeout(tryAttach, 100);
    } else {
      console.error('Sidebar sign out button not found after multiple attempts');
    }
  }
  tryAttach();
})();

function getPasswordStrength(pw) {
  let score = 0;
  if (pw.length >= 8) score++;
  if (/[a-z]/.test(pw)) score++;
  if (/[A-Z]/.test(pw)) score++;
  if (/[0-9]/.test(pw)) score++;
  if (/[^A-Za-z0-9]/.test(pw)) score++;
  return score;
}
function getStrengthLabel(score) {
  if (score <= 2) return {label: 'Weak', color: '#ef4444'};
  if (score === 3) return {label: 'Medium', color: '#f59e42'};
  return {label: 'Strong', color: '#22c55e'};
}
document.getElementById('newPassword').addEventListener('input', function() {
  const pw = this.value;
  const strengthDiv = document.getElementById('passwordStrength');
  if (!pw) {
    strengthDiv.innerHTML = '';
    return;
  }
  const strength = getPasswordStrength(pw);
  const {label, color} = getStrengthLabel(strength);
  let msg = `Strength: <span style='color:${color}'>${label}</span>`;
  if (strength < 4) {
    msg += "<br><span style='color:#64748b;font-weight:400'>Use at least 8 characters, with capital letters, lowercase, and numbers.</span>";
  }
  strengthDiv.innerHTML = msg;
});

// --- Change Email with OTP logic (client-side demo version) ---
// The 'Request OTP' button should be visible by default, and only the OTP input/resend/verify buttons are hidden until requested.
let resendEmailOtpTimer = 60;
let resendEmailOtpInterval;
function startResendEmailOtpTimer() {
  const resendBtn = document.getElementById('resendEmailOtpBtn');
  resendBtn.disabled = true;
  resendBtn.style.opacity = '0.6';
  resendBtn.style.cursor = 'not-allowed';
  resendBtn.textContent = `Resend Code (${resendEmailOtpTimer}s)`;
  resendBtn.style.display = '';
  if (resendEmailOtpInterval) clearInterval(resendEmailOtpInterval);
  resendEmailOtpInterval = setInterval(() => {
    resendEmailOtpTimer--;
    resendBtn.textContent = `Resend Code (${resendEmailOtpTimer}s)`;
    if (resendEmailOtpTimer <= 0) {
      clearInterval(resendEmailOtpInterval);
      resendBtn.disabled = false;
      resendBtn.style.opacity = '1';
      resendBtn.style.cursor = 'pointer';
      resendBtn.textContent = 'Resend Code';
      resendEmailOtpTimer = 60;
    }
  }, 1000);
}
document.getElementById('requestEmailOtpBtn').addEventListener('click', async function() {
  const newEmail = document.getElementById('newEmail').value.trim();
  const msg = document.getElementById('emailOtpRequestMsg');
  msg.textContent = '';
  if (!newEmail || !/^\S+@\S+\.\S+$/.test(newEmail)) {
    msg.textContent = 'Please enter a valid email address.';
    msg.style.color = 'red';
    return;
  }
  // Generate a random 6-digit OTP and expiry
  const otp = Math.floor(100000 + Math.random() * 900000).toString();
  const expires = new Date(Date.now() + 20 * 60 * 1000).toISOString();
  // Store OTP and expiry in Supabase users table for this user
  let user = JSON.parse(localStorage.getItem('gmt_user') || sessionStorage.getItem('gmt_user') || '{}');
  const { error } = await supabase
    .from('users')
    .update({ otp_code: otp, otp_expires: expires, pending_email: newEmail })
    .eq('id', user.id);
  if (error) {
    msg.textContent = 'Failed to generate OTP: ' + error.message;
    msg.style.color = 'red';
    return;
  }
  msg.innerHTML = 'OTP sent to ' + newEmail + '. <b>Demo OTP: ' + otp + '</b> (In production, this would be emailed.)';
  msg.style.color = 'green';
  document.getElementById('otpSection').style.display = '';
  document.getElementById('resendEmailOtpBtn').style.display = '';
  resendEmailOtpTimer = 60;
  startResendEmailOtpTimer();
});
document.getElementById('resendEmailOtpBtn').addEventListener('click', async function() {
  if (this.disabled) return;
  const newEmail = document.getElementById('newEmail').value.trim();
  const msg = document.getElementById('emailOtpRequestMsg');
  if (!newEmail || !/^\S+@\S+\.\S+$/.test(newEmail)) {
    msg.textContent = 'Please enter a valid email address.';
    msg.style.color = 'red';
    return;
  }
  // Generate a new OTP and expiry
  const otp = Math.floor(100000 + Math.random() * 900000).toString();
  const expires = new Date(Date.now() + 20 * 60 * 1000).toISOString();
  let user = JSON.parse(localStorage.getItem('gmt_user') || sessionStorage.getItem('gmt_user') || '{}');
  const { error } = await supabase
    .from('users')
    .update({ otp_code: otp, otp_expires: expires, pending_email: newEmail })
    .eq('id', user.id);
  if (error) {
    msg.textContent = 'Failed to resend OTP: ' + error.message;
    msg.style.color = 'red';
    return;
  }
  msg.innerHTML = 'OTP resent to ' + newEmail + '. <b>Demo OTP: ' + otp + '</b> (In production, this would be emailed.)';
  msg.style.color = 'green';
  resendEmailOtpTimer = 60;
  startResendEmailOtpTimer();
});
document.getElementById('verifyEmailOtpBtn').addEventListener('click', async function() {
  const newEmail = document.getElementById('newEmail').value.trim();
  const otp = document.getElementById('emailOtp').value.trim();
  const msg = document.getElementById('emailOtpVerifyMsg');
  msg.textContent = '';
  let user = JSON.parse(localStorage.getItem('gmt_user') || sessionStorage.getItem('gmt_user') || '{}');
  // Fetch OTP and expiry from Supabase
  const { data, error } = await supabase
    .from('users')
    .select('otp_code, otp_expires, pending_email')
    .eq('id', user.id)
    .single();
  if (error || !data) {
    msg.textContent = 'Failed to verify OTP.';
    msg.style.color = 'red';
    return;
  }
  if (!data.otp_code || !data.otp_expires || !data.pending_email) {
    msg.textContent = 'No OTP request found for this email.';
    msg.style.color = 'red';
    return;
  }
  if (data.pending_email !== newEmail) {
    msg.textContent = 'This OTP was not requested for this email.';
    msg.style.color = 'red';
    return;
  }
  if (!otp || otp.length !== 6 || !/^[0-9]{6}$/.test(otp)) {
    msg.textContent = 'Please enter the 6-digit OTP code.';
    msg.style.color = 'red';
    return;
  }
  if (data.otp_code !== otp) {
    msg.textContent = 'Invalid OTP code.';
    msg.style.color = 'red';
    return;
  }
  // Check expiry
  const now = Date.now();
  let expiresStr = data.otp_expires;
  if (expiresStr && !expiresStr.endsWith('Z')) expiresStr += 'Z';
  const expires = new Date(expiresStr).getTime();
  if (expires < now) {
    msg.textContent = 'OTP code expired.';
    msg.style.color = 'red';
    return;
  }
  // Success: update the profile email field in the UI and in Supabase
  document.getElementById('profileEmail').value = newEmail;
  if (user) {
    user.email = newEmail;
    if (localStorage.getItem('gmt_user')) localStorage.setItem('gmt_user', JSON.stringify(user));
    if (sessionStorage.getItem('gmt_user')) sessionStorage.setItem('gmt_user', JSON.stringify(user));
  }
  // Update email in Supabase users table and clear OTP fields
  try {
    const { error: updateError } = await supabase
      .from('users')
      .update({ email: newEmail, otp_code: null, otp_expires: null, pending_email: null })
      .eq('id', user.id);
    if (updateError) {
      msg.textContent = 'Email changed locally, but failed to update in database: ' + updateError.message;
      msg.style.color = 'red';
    } else {
      msg.textContent = 'Email changed successfully!';
      msg.style.color = 'green';
    }
  } catch (e) {
    msg.textContent = 'Email changed locally, but error updating database.';
    msg.style.color = 'red';
  }
  setTimeout(() => {
    document.getElementById('otpSection').style.display = 'none';
    document.getElementById('newEmail').value = '';
    msg.textContent = '';
    document.getElementById('emailOtpRequestMsg').textContent = '';
    // Reset resend button
    document.getElementById('resendEmailOtpBtn').disabled = true;
    document.getElementById('resendEmailOtpBtn').style.opacity = '0.6';
    document.getElementById('resendEmailOtpBtn').style.cursor = 'not-allowed';
    document.getElementById('resendEmailOtpBtn').textContent = 'Resend Code (60s)';
    resendEmailOtpTimer = 60;
    if (resendEmailOtpInterval) clearInterval(resendEmailOtpInterval);
  }, 2000);
});

</script>
</body>
</html> 